{"version":3,"sources":["../../../../../src/modules/dynamic-cms/controller/dynamic-data/dynamic-data.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, FilterQuery, Types } from 'mongoose';\r\nimport {\r\n  DynamicData,\r\n  DynamicDataDocument,\r\n} from '../../schemas/dynamic-data.schema';\r\nimport { CollectionSchemaService } from '../collection-schema/collection-schema.service';\r\nimport {\r\n  PaginationDto,\r\n  PaginationResponse,\r\n} from '../../../../common/dto/pagination.dto';\r\n\r\n@Injectable()\r\nexport class DynamicDataService {\r\n  constructor(\r\n    @InjectModel(DynamicData.name)\r\n    private dynamicDataModel: Model<DynamicDataDocument>,\r\n    private collectionSchemaService: CollectionSchemaService,\r\n  ) {}\r\n\r\n  /**\r\n   * Transform document để trả về data phẳng, không có lớp _data\r\n   */\r\n  private transformDocument(doc: any): any {\r\n    if (!doc) return null;\r\n\r\n    const plainDoc = doc.toObject ? doc.toObject() : doc;\r\n    const { _data, ...rest } = plainDoc;\r\n\r\n    return {\r\n      ...rest,\r\n      ..._data, // Flatten _data vào root level\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Transform array of documents\r\n   */\r\n  private transformDocuments(docs: any[]): any[] {\r\n    return docs.map((doc) => this.transformDocument(doc));\r\n  }\r\n\r\n  /**\r\n   * Tạo document mới trong collection động\r\n   */\r\n  async create(\r\n    collectionName: string,\r\n    databaseId: string,\r\n    data: Record<string, any>,\r\n    userId: string | null,\r\n  ): Promise<DynamicData> {\r\n    // Kiểm tra collection schema có tồn tại không (không check ownership)\r\n    const schema = await this.collectionSchemaService.findByNamePublic(\r\n      collectionName,\r\n      databaseId,\r\n    );\r\n\r\n    if (!schema) {\r\n      throw new NotFoundException(\r\n        `Collection schema \"${collectionName}\" not found`,\r\n      );\r\n    }\r\n\r\n    // Validate dữ liệu (public - không check ownership)\r\n    const validation = await this.collectionSchemaService.validateDataPublic(\r\n      collectionName,\r\n      databaseId,\r\n      data,\r\n    );\r\n    if (!validation.valid) {\r\n      throw new BadRequestException({\r\n        message: 'Validation failed',\r\n        errors: validation.errors,\r\n      });\r\n    }\r\n\r\n    // Tạo document\r\n    const document = new this.dynamicDataModel({\r\n      _collection: collectionName,\r\n      userId: userId ? new Types.ObjectId(userId) : null,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      _data: data,\r\n      createdBy: userId,\r\n      updatedBy: userId,\r\n    });\r\n\r\n    const saved = await document.save();\r\n    return this.transformDocument(saved);\r\n  }\r\n\r\n  /**\r\n   * Tạo nhiều documents cùng lúc (bulk create)\r\n   */\r\n  async createMany(\r\n    collectionName: string,\r\n    databaseId: string,\r\n    dataArray: Record<string, any>[],\r\n    userId: string | null,\r\n  ): Promise<{\r\n    success: number;\r\n    failed: number;\r\n    results: Array<{\r\n      success: boolean;\r\n      data?: DynamicData;\r\n      error?: string;\r\n      index: number;\r\n    }>;\r\n  }> {\r\n    // Kiểm tra collection schema có tồn tại không\r\n    const schema = await this.collectionSchemaService.findByNamePublic(\r\n      collectionName,\r\n      databaseId,\r\n    );\r\n\r\n    if (!schema) {\r\n      throw new NotFoundException(\r\n        `Collection schema \"${collectionName}\" not found`,\r\n      );\r\n    }\r\n\r\n    const results = [];\r\n    let successCount = 0;\r\n    let failedCount = 0;\r\n\r\n    // Xử lý từng document\r\n    for (let i = 0; i < dataArray.length; i++) {\r\n      try {\r\n        const data = dataArray[i];\r\n\r\n        // Validate dữ liệu\r\n        const validation =\r\n          await this.collectionSchemaService.validateDataPublic(\r\n            collectionName,\r\n            databaseId,\r\n            data,\r\n          );\r\n\r\n        if (!validation.valid) {\r\n          results.push({\r\n            success: false,\r\n            error: `Validation failed: ${JSON.stringify(validation.errors)}`,\r\n            index: i,\r\n          });\r\n          failedCount++;\r\n          continue;\r\n        }\r\n\r\n        // Tạo document\r\n        const document = new this.dynamicDataModel({\r\n          _collection: collectionName,\r\n          userId: userId ? new Types.ObjectId(userId) : null,\r\n          databaseId: new Types.ObjectId(databaseId),\r\n          _data: data,\r\n          createdBy: userId,\r\n          updatedBy: userId,\r\n        });\r\n\r\n        const saved = await document.save();\r\n        results.push({\r\n          success: true,\r\n          data: this.transformDocument(saved),\r\n          index: i,\r\n        });\r\n        successCount++;\r\n      } catch (error) {\r\n        results.push({\r\n          success: false,\r\n          error: error.message || 'Unknown error',\r\n          index: i,\r\n        });\r\n        failedCount++;\r\n      }\r\n    }\r\n\r\n    return {\r\n      success: successCount,\r\n      failed: failedCount,\r\n      results,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Thay thế toàn bộ data cũ bằng data mới (replace all)\r\n   * Xóa tất cả documents cũ và tạo mới từ mảng\r\n   */\r\n  async replaceAll(\r\n    collectionName: string,\r\n    databaseId: string,\r\n    dataArray: Record<string, any>[],\r\n    userId: string | null,\r\n  ): Promise<{\r\n    deleted: number;\r\n    created: number;\r\n    failed: number;\r\n    results: Array<{\r\n      success: boolean;\r\n      data?: DynamicData;\r\n      error?: string;\r\n      index: number;\r\n    }>;\r\n  }> {\r\n    // Kiểm tra collection schema có tồn tại không\r\n    const schema = await this.collectionSchemaService.findByNamePublic(\r\n      collectionName,\r\n      databaseId,\r\n    );\r\n\r\n    if (!schema) {\r\n      throw new NotFoundException(\r\n        `Collection schema \"${collectionName}\" not found`,\r\n      );\r\n    }\r\n\r\n    // Xóa tất cả documents cũ trong collection\r\n    const deleteQuery: FilterQuery<DynamicDataDocument> = {\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n    };\r\n\r\n    // Chỉ xóa documents của user nếu có userId\r\n    if (userId) {\r\n      deleteQuery.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const deleteResult = await this.dynamicDataModel.deleteMany(deleteQuery);\r\n    const deletedCount = deleteResult.deletedCount || 0;\r\n\r\n    // Tạo documents mới\r\n    const results = [];\r\n    let createdCount = 0;\r\n    let failedCount = 0;\r\n\r\n    for (let i = 0; i < dataArray.length; i++) {\r\n      try {\r\n        const data = dataArray[i];\r\n\r\n        // Validate dữ liệu\r\n        const validation =\r\n          await this.collectionSchemaService.validateDataPublic(\r\n            collectionName,\r\n            databaseId,\r\n            data,\r\n          );\r\n\r\n        if (!validation.valid) {\r\n          results.push({\r\n            success: false,\r\n            error: `Validation failed: ${JSON.stringify(validation.errors)}`,\r\n            index: i,\r\n          });\r\n          failedCount++;\r\n          continue;\r\n        }\r\n\r\n        // Tạo document mới\r\n        const document = new this.dynamicDataModel({\r\n          _collection: collectionName,\r\n          userId: userId ? new Types.ObjectId(userId) : null,\r\n          databaseId: new Types.ObjectId(databaseId),\r\n          _data: data,\r\n          createdBy: userId,\r\n          updatedBy: userId,\r\n        });\r\n\r\n        const saved = await document.save();\r\n        results.push({\r\n          success: true,\r\n          data: this.transformDocument(saved),\r\n          index: i,\r\n        });\r\n        createdCount++;\r\n      } catch (error) {\r\n        results.push({\r\n          success: false,\r\n          error: error.message || 'Unknown error',\r\n          index: i,\r\n        });\r\n        failedCount++;\r\n      }\r\n    }\r\n\r\n    return {\r\n      deleted: deletedCount,\r\n      created: createdCount,\r\n      failed: failedCount,\r\n      results,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Lấy danh sách documents trong collection của user\r\n   */\r\n  async findAll(\r\n    collectionName: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n    paginationDto: PaginationDto,\r\n    filter?: Record<string, any>,\r\n  ): Promise<PaginationResponse<DynamicData>> {\r\n    const { page = 1, limit = 10, search } = paginationDto;\r\n    const skip = (page - 1) * limit;\r\n\r\n    // Kiểm tra collection schema (không check ownership)\r\n    const schema = await this.collectionSchemaService.findByNamePublic(\r\n      collectionName,\r\n      databaseId,\r\n    );\r\n\r\n    if (!schema) {\r\n      throw new NotFoundException(\r\n        `Collection schema \"${collectionName}\" not found`,\r\n      );\r\n    }\r\n\r\n    // Build query\r\n    const query: FilterQuery<DynamicDataDocument> = {\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null, // Không lấy các bản ghi đã xóa\r\n    };\r\n\r\n    // Chỉ thêm userId filter nếu có\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    // Thêm filter nếu có\r\n    if (filter) {\r\n      Object.keys(filter).forEach((key) => {\r\n        query[`_data.${key}`] = filter[key];\r\n      });\r\n    }\r\n\r\n    // Thêm search nếu có\r\n    if (search) {\r\n      const searchableFields = schema.fields\r\n        .filter((f) => f.searchable)\r\n        .map((f) => f.name);\r\n\r\n      if (searchableFields.length > 0) {\r\n        query.$or = searchableFields.map((fieldName) => ({\r\n          [`_data.${fieldName}`]: { $regex: search, $options: 'i' },\r\n        }));\r\n      }\r\n    }\r\n\r\n    const [data, total] = await Promise.all([\r\n      this.dynamicDataModel\r\n        .find(query)\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .sort({ createdAt: -1 })\r\n        .exec(),\r\n      this.dynamicDataModel.countDocuments(query).exec(),\r\n    ]);\r\n\r\n    return {\r\n      data: this.transformDocuments(data),\r\n      total,\r\n      page,\r\n      limit,\r\n      totalPages: Math.ceil(total / limit),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Lấy document theo ID và kiểm tra ownership\r\n   */\r\n  async findById(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const document = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    return this.transformDocument(document);\r\n  }\r\n\r\n  /**\r\n   * Cập nhật document\r\n   */\r\n  async update(\r\n    collectionName: string,\r\n    id: string,\r\n    databaseId: string,\r\n    data: Record<string, any>,\r\n    userId: string | null,\r\n  ): Promise<DynamicData | null> {\r\n    // Kiểm tra document có tồn tại không và kiểm tra ownership\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const existing = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!existing) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    // Merge data cũ với data mới\r\n    const mergedData = { ...existing._data, ...data };\r\n\r\n    // Validate dữ liệu mới (public)\r\n    const validation = await this.collectionSchemaService.validateDataPublic(\r\n      collectionName,\r\n      databaseId,\r\n      mergedData,\r\n    );\r\n    if (!validation.valid) {\r\n      throw new BadRequestException({\r\n        message: 'Validation failed',\r\n        errors: validation.errors,\r\n      });\r\n    }\r\n\r\n    // Cập nhật\r\n    const updated = await this.dynamicDataModel\r\n      .findByIdAndUpdate(\r\n        id,\r\n        {\r\n          _data: mergedData,\r\n          updatedBy: userId,\r\n        },\r\n        { new: true },\r\n      )\r\n      .exec();\r\n\r\n    return this.transformDocument(updated);\r\n  }\r\n\r\n  /**\r\n   * Thay thế hoàn toàn document (PUT)\r\n   */\r\n  async replace(\r\n    collectionName: string,\r\n    id: string,\r\n    databaseId: string,\r\n    data: Record<string, any>,\r\n    userId: string | null,\r\n  ): Promise<any> {\r\n    // Kiểm tra document có tồn tại không và kiểm tra ownership\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const existing = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!existing) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    // Validate dữ liệu mới (không merge, thay thế hoàn toàn) - public\r\n    const validation = await this.collectionSchemaService.validateDataPublic(\r\n      collectionName,\r\n      databaseId,\r\n      data,\r\n    );\r\n    if (!validation.valid) {\r\n      throw new BadRequestException({\r\n        message: 'Validation failed',\r\n        errors: validation.errors,\r\n      });\r\n    }\r\n\r\n    // Thay thế hoàn toàn\r\n    const replaced = await this.dynamicDataModel\r\n      .findByIdAndUpdate(\r\n        id,\r\n        {\r\n          _data: data, // Thay thế hoàn toàn, không merge\r\n          updatedBy: userId,\r\n        },\r\n        { new: true },\r\n      )\r\n      .exec();\r\n\r\n    return this.transformDocument(replaced);\r\n  }\r\n\r\n  /**\r\n   * Xóa document (soft delete)\r\n   */\r\n  async softDelete(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const document = await this.findById(\r\n      collectionName,\r\n      id,\r\n      userId,\r\n      databaseId,\r\n    );\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    const deleted = await this.dynamicDataModel\r\n      .findByIdAndUpdate(id, { deletedAt: new Date() }, { new: true })\r\n      .exec();\r\n\r\n    return this.transformDocument(deleted);\r\n  }\r\n\r\n  /**\r\n   * Xóa document vĩnh viễn\r\n   */\r\n  async hardDelete(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const document = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    const deleted = await this.dynamicDataModel.findByIdAndDelete(id).exec();\r\n    return this.transformDocument(deleted);\r\n  }\r\n\r\n  /**\r\n   * Restore document đã xóa\r\n   */\r\n  async restore(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const document = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    const restored = await this.dynamicDataModel\r\n      .findByIdAndUpdate(id, { deletedAt: null }, { new: true })\r\n      .exec();\r\n\r\n    return this.transformDocument(restored);\r\n  }\r\n\r\n  /**\r\n   * Query với điều kiện phức tạp\r\n   */\r\n  async query(\r\n    collectionName: string,\r\n    queryFilter: Record<string, any>,\r\n    options?: {\r\n      sort?: Record<string, 1 | -1>;\r\n      limit?: number;\r\n      skip?: number;\r\n    },\r\n  ): Promise<DynamicData[]> {\r\n    const query: FilterQuery<DynamicDataDocument> = {\r\n      _collection: collectionName,\r\n      deletedAt: null,\r\n    };\r\n\r\n    // Transform filter to query _data fields\r\n    Object.keys(queryFilter).forEach((key) => {\r\n      query[`_data.${key}`] = queryFilter[key];\r\n    });\r\n\r\n    let queryBuilder = this.dynamicDataModel.find(query);\r\n\r\n    if (options?.sort) {\r\n      queryBuilder = queryBuilder.sort(options.sort);\r\n    }\r\n\r\n    if (options?.skip) {\r\n      queryBuilder = queryBuilder.skip(options.skip);\r\n    }\r\n\r\n    if (options?.limit) {\r\n      queryBuilder = queryBuilder.limit(options.limit);\r\n    }\r\n\r\n    const results = await queryBuilder.exec();\r\n    return this.transformDocuments(results);\r\n  }\r\n\r\n  /**\r\n   * Đếm số lượng documents\r\n   */\r\n  async count(\r\n    collectionName: string,\r\n    filter?: Record<string, any>,\r\n  ): Promise<number> {\r\n    const query: FilterQuery<DynamicDataDocument> = {\r\n      _collection: collectionName,\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (filter) {\r\n      Object.keys(filter).forEach((key) => {\r\n        query[`_data.${key}`] = filter[key];\r\n      });\r\n    }\r\n\r\n    return this.dynamicDataModel.countDocuments(query).exec();\r\n  }\r\n}\r\n"],"names":["DynamicDataService","transformDocument","doc","plainDoc","toObject","_data","rest","transformDocuments","docs","map","create","collectionName","databaseId","data","userId","schema","collectionSchemaService","findByNamePublic","NotFoundException","validation","validateDataPublic","valid","BadRequestException","message","errors","document","dynamicDataModel","_collection","Types","ObjectId","createdBy","updatedBy","saved","save","createMany","dataArray","results","successCount","failedCount","i","length","push","success","error","JSON","stringify","index","failed","replaceAll","deleteQuery","deleteResult","deleteMany","deletedCount","createdCount","deleted","created","findAll","paginationDto","filter","page","limit","search","skip","query","deletedAt","Object","keys","forEach","key","searchableFields","fields","f","searchable","name","$or","fieldName","$regex","$options","total","Promise","all","find","sort","createdAt","exec","countDocuments","totalPages","Math","ceil","findById","id","_id","findOne","update","existing","mergedData","updated","findByIdAndUpdate","new","replace","replaced","softDelete","Date","hardDelete","findByIdAndDelete","restore","restored","queryFilter","options","queryBuilder","count"],"mappings":"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"}