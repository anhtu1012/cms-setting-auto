{"version":3,"sources":["../../../../../src/modules/dynamic-cms/controller/dynamic-data/dynamic-data.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, FilterQuery, Types } from 'mongoose';\r\nimport {\r\n  DynamicData,\r\n  DynamicDataDocument,\r\n} from '../../schemas/dynamic-data.schema';\r\nimport { CollectionSchemaService } from '../collection-schema/collection-schema.service';\r\nimport {\r\n  PaginationDto,\r\n  PaginationResponse,\r\n} from '../../../../common/dto/pagination.dto';\r\n\r\n@Injectable()\r\nexport class DynamicDataService {\r\n  constructor(\r\n    @InjectModel(DynamicData.name)\r\n    private dynamicDataModel: Model<DynamicDataDocument>,\r\n    private collectionSchemaService: CollectionSchemaService,\r\n  ) {}\r\n\r\n  /**\r\n   * Transform document để trả về data phẳng, không có lớp _data\r\n   */\r\n  private transformDocument(doc: any): any {\r\n    if (!doc) return null;\r\n\r\n    const plainDoc = doc.toObject ? doc.toObject() : doc;\r\n    const { _data, ...rest } = plainDoc;\r\n\r\n    return {\r\n      ...rest,\r\n      ..._data, // Flatten _data vào root level\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Transform array of documents\r\n   */\r\n  private transformDocuments(docs: any[]): any[] {\r\n    return docs.map((doc) => this.transformDocument(doc));\r\n  }\r\n\r\n  /**\r\n   * Tạo document mới trong collection động\r\n   */\r\n  async create(\r\n    collectionName: string,\r\n    databaseId: string,\r\n    data: Record<string, any>,\r\n    userId: string | null,\r\n  ): Promise<DynamicData> {\r\n    // Kiểm tra collection schema có tồn tại không (không check ownership)\r\n    const schema = await this.collectionSchemaService.findByNamePublic(\r\n      collectionName,\r\n      databaseId,\r\n    );\r\n\r\n    if (!schema) {\r\n      throw new NotFoundException(\r\n        `Collection schema \"${collectionName}\" not found`,\r\n      );\r\n    }\r\n\r\n    // Validate dữ liệu (public - không check ownership)\r\n    const validation = await this.collectionSchemaService.validateDataPublic(\r\n      collectionName,\r\n      databaseId,\r\n      data,\r\n    );\r\n    if (!validation.valid) {\r\n      throw new BadRequestException({\r\n        message: 'Validation failed',\r\n        errors: validation.errors,\r\n      });\r\n    }\r\n\r\n    // Tạo document\r\n    const document = new this.dynamicDataModel({\r\n      _collection: collectionName,\r\n      userId: userId ? new Types.ObjectId(userId) : null,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      _data: data,\r\n      createdBy: userId,\r\n      updatedBy: userId,\r\n    });\r\n\r\n    const saved = await document.save();\r\n    return this.transformDocument(saved);\r\n  }\r\n\r\n  /**\r\n   * Lấy danh sách documents trong collection của user\r\n   */\r\n  async findAll(\r\n    collectionName: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n    paginationDto: PaginationDto,\r\n    filter?: Record<string, any>,\r\n  ): Promise<PaginationResponse<DynamicData>> {\r\n    const { page = 1, limit = 10, search } = paginationDto;\r\n    const skip = (page - 1) * limit;\r\n\r\n    // Kiểm tra collection schema (không check ownership)\r\n    const schema = await this.collectionSchemaService.findByNamePublic(\r\n      collectionName,\r\n      databaseId,\r\n    );\r\n\r\n    if (!schema) {\r\n      throw new NotFoundException(\r\n        `Collection schema \"${collectionName}\" not found`,\r\n      );\r\n    }\r\n\r\n    // Build query\r\n    const query: FilterQuery<DynamicDataDocument> = {\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null, // Không lấy các bản ghi đã xóa\r\n    };\r\n\r\n    // Chỉ thêm userId filter nếu có\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    // Thêm filter nếu có\r\n    if (filter) {\r\n      Object.keys(filter).forEach((key) => {\r\n        query[`_data.${key}`] = filter[key];\r\n      });\r\n    }\r\n\r\n    // Thêm search nếu có\r\n    if (search) {\r\n      const searchableFields = schema.fields\r\n        .filter((f) => f.searchable)\r\n        .map((f) => f.name);\r\n\r\n      if (searchableFields.length > 0) {\r\n        query.$or = searchableFields.map((fieldName) => ({\r\n          [`_data.${fieldName}`]: { $regex: search, $options: 'i' },\r\n        }));\r\n      }\r\n    }\r\n\r\n    const [data, total] = await Promise.all([\r\n      this.dynamicDataModel\r\n        .find(query)\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .sort({ createdAt: -1 })\r\n        .exec(),\r\n      this.dynamicDataModel.countDocuments(query).exec(),\r\n    ]);\r\n\r\n    return {\r\n      data: this.transformDocuments(data),\r\n      total,\r\n      page,\r\n      limit,\r\n      totalPages: Math.ceil(total / limit),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Lấy document theo ID và kiểm tra ownership\r\n   */\r\n  async findById(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const document = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    return this.transformDocument(document);\r\n  }\r\n\r\n  /**\r\n   * Cập nhật document\r\n   */\r\n  async update(\r\n    collectionName: string,\r\n    id: string,\r\n    databaseId: string,\r\n    data: Record<string, any>,\r\n    userId: string | null,\r\n  ): Promise<DynamicData | null> {\r\n    // Kiểm tra document có tồn tại không và kiểm tra ownership\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const existing = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!existing) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    // Merge data cũ với data mới\r\n    const mergedData = { ...existing._data, ...data };\r\n\r\n    // Validate dữ liệu mới (public)\r\n    const validation = await this.collectionSchemaService.validateDataPublic(\r\n      collectionName,\r\n      databaseId,\r\n      mergedData,\r\n    );\r\n    if (!validation.valid) {\r\n      throw new BadRequestException({\r\n        message: 'Validation failed',\r\n        errors: validation.errors,\r\n      });\r\n    }\r\n\r\n    // Cập nhật\r\n    const updated = await this.dynamicDataModel\r\n      .findByIdAndUpdate(\r\n        id,\r\n        {\r\n          _data: mergedData,\r\n          updatedBy: userId,\r\n        },\r\n        { new: true },\r\n      )\r\n      .exec();\r\n\r\n    return this.transformDocument(updated);\r\n  }\r\n\r\n  /**\r\n   * Thay thế hoàn toàn document (PUT)\r\n   */\r\n  async replace(\r\n    collectionName: string,\r\n    id: string,\r\n    databaseId: string,\r\n    data: Record<string, any>,\r\n    userId: string | null,\r\n  ): Promise<any> {\r\n    // Kiểm tra document có tồn tại không và kiểm tra ownership\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const existing = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!existing) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    // Validate dữ liệu mới (không merge, thay thế hoàn toàn) - public\r\n    const validation = await this.collectionSchemaService.validateDataPublic(\r\n      collectionName,\r\n      databaseId,\r\n      data,\r\n    );\r\n    if (!validation.valid) {\r\n      throw new BadRequestException({\r\n        message: 'Validation failed',\r\n        errors: validation.errors,\r\n      });\r\n    }\r\n\r\n    // Thay thế hoàn toàn\r\n    const replaced = await this.dynamicDataModel\r\n      .findByIdAndUpdate(\r\n        id,\r\n        {\r\n          _data: data, // Thay thế hoàn toàn, không merge\r\n          updatedBy: userId,\r\n        },\r\n        { new: true },\r\n      )\r\n      .exec();\r\n\r\n    return this.transformDocument(replaced);\r\n  }\r\n\r\n  /**\r\n   * Xóa document (soft delete)\r\n   */\r\n  async softDelete(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const document = await this.findById(\r\n      collectionName,\r\n      id,\r\n      userId,\r\n      databaseId,\r\n    );\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    const deleted = await this.dynamicDataModel\r\n      .findByIdAndUpdate(id, { deletedAt: new Date() }, { new: true })\r\n      .exec();\r\n\r\n    return this.transformDocument(deleted);\r\n  }\r\n\r\n  /**\r\n   * Xóa document vĩnh viễn\r\n   */\r\n  async hardDelete(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const document = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    const deleted = await this.dynamicDataModel.findByIdAndDelete(id).exec();\r\n    return this.transformDocument(deleted);\r\n  }\r\n\r\n  /**\r\n   * Restore document đã xóa\r\n   */\r\n  async restore(\r\n    collectionName: string,\r\n    id: string,\r\n    userId: string | null,\r\n    databaseId: string,\r\n  ): Promise<DynamicData | null> {\r\n    const query: any = {\r\n      _id: id,\r\n      _collection: collectionName,\r\n      databaseId: new Types.ObjectId(databaseId),\r\n    };\r\n\r\n    if (userId) {\r\n      query.userId = new Types.ObjectId(userId);\r\n    }\r\n\r\n    const document = await this.dynamicDataModel.findOne(query).exec();\r\n\r\n    if (!document) {\r\n      throw new NotFoundException(\r\n        `Document not found in collection \"${collectionName}\"`,\r\n      );\r\n    }\r\n\r\n    const restored = await this.dynamicDataModel\r\n      .findByIdAndUpdate(id, { deletedAt: null }, { new: true })\r\n      .exec();\r\n\r\n    return this.transformDocument(restored);\r\n  }\r\n\r\n  /**\r\n   * Query với điều kiện phức tạp\r\n   */\r\n  async query(\r\n    collectionName: string,\r\n    queryFilter: Record<string, any>,\r\n    options?: {\r\n      sort?: Record<string, 1 | -1>;\r\n      limit?: number;\r\n      skip?: number;\r\n    },\r\n  ): Promise<DynamicData[]> {\r\n    const query: FilterQuery<DynamicDataDocument> = {\r\n      _collection: collectionName,\r\n      deletedAt: null,\r\n    };\r\n\r\n    // Transform filter to query _data fields\r\n    Object.keys(queryFilter).forEach((key) => {\r\n      query[`_data.${key}`] = queryFilter[key];\r\n    });\r\n\r\n    let queryBuilder = this.dynamicDataModel.find(query);\r\n\r\n    if (options?.sort) {\r\n      queryBuilder = queryBuilder.sort(options.sort);\r\n    }\r\n\r\n    if (options?.skip) {\r\n      queryBuilder = queryBuilder.skip(options.skip);\r\n    }\r\n\r\n    if (options?.limit) {\r\n      queryBuilder = queryBuilder.limit(options.limit);\r\n    }\r\n\r\n    const results = await queryBuilder.exec();\r\n    return this.transformDocuments(results);\r\n  }\r\n\r\n  /**\r\n   * Đếm số lượng documents\r\n   */\r\n  async count(\r\n    collectionName: string,\r\n    filter?: Record<string, any>,\r\n  ): Promise<number> {\r\n    const query: FilterQuery<DynamicDataDocument> = {\r\n      _collection: collectionName,\r\n      deletedAt: null,\r\n    };\r\n\r\n    if (filter) {\r\n      Object.keys(filter).forEach((key) => {\r\n        query[`_data.${key}`] = filter[key];\r\n      });\r\n    }\r\n\r\n    return this.dynamicDataModel.countDocuments(query).exec();\r\n  }\r\n}\r\n"],"names":["DynamicDataService","transformDocument","doc","plainDoc","toObject","_data","rest","transformDocuments","docs","map","create","collectionName","databaseId","data","userId","schema","collectionSchemaService","findByNamePublic","NotFoundException","validation","validateDataPublic","valid","BadRequestException","message","errors","document","dynamicDataModel","_collection","Types","ObjectId","createdBy","updatedBy","saved","save","findAll","paginationDto","filter","page","limit","search","skip","query","deletedAt","Object","keys","forEach","key","searchableFields","fields","f","searchable","name","length","$or","fieldName","$regex","$options","total","Promise","all","find","sort","createdAt","exec","countDocuments","totalPages","Math","ceil","findById","id","_id","findOne","update","existing","mergedData","updated","findByIdAndUpdate","new","replace","replaced","softDelete","deleted","Date","hardDelete","findByIdAndDelete","restore","restored","queryFilter","options","queryBuilder","results","count"],"mappings":"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"}