{"version":3,"sources":["../../../../../src/modules/dynamic-cms/controller/collection-schema/collection-schema.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Body,\r\n  Patch,\r\n  Param,\r\n  Delete,\r\n  Query,\r\n  UseGuards,\r\n  Request,\r\n  NotFoundException,\r\n} from '@nestjs/common';\r\nimport {\r\n  ApiTags,\r\n  ApiOperation,\r\n  ApiResponse,\r\n  ApiQuery,\r\n  ApiParam,\r\n  ApiBody,\r\n  ApiBearerAuth,\r\n  ApiHeader,\r\n} from '@nestjs/swagger';\r\nimport {\r\n  CreateCollectionSchemaDto,\r\n  UpdateCollectionSchemaDto,\r\n} from '../../dto/collection-schema.dto';\r\nimport { PaginationDto } from '../../../../common/dto/pagination.dto';\r\nimport { JwtAuthGuard } from '../../../auth/guards/jwt-auth.guard';\r\nimport { DatabaseOwnershipGuard } from '../../../../common/guards/database-ownership.guard';\r\nimport { DatabaseId } from '../../../../common/decorators/database-id.decorator';\r\nimport { CollectionSchemaService } from './collection-schema.service';\r\nimport { COLLECTION_SCHEMA_ROUTES } from '../../../../common/constants/api-routes.constants';\r\n\r\n@ApiTags('collection-schemas')\r\n@Controller(COLLECTION_SCHEMA_ROUTES.BASE)\r\n@UseGuards(JwtAuthGuard, DatabaseOwnershipGuard)\r\n@ApiBearerAuth()\r\n@ApiHeader({\r\n  name: 'x-database-id',\r\n  description: 'Database ID that user has access to',\r\n  required: true,\r\n  schema: { type: 'string', example: '507f1f77bcf86cd799439011' },\r\n})\r\nexport class CollectionSchemaController {\r\n  constructor(\r\n    private readonly collectionSchemaService: CollectionSchemaService,\r\n  ) {}\r\n\r\n  @Post()\r\n  @ApiOperation({ summary: 'Create a new collection schema (table)' })\r\n  @ApiResponse({\r\n    status: 201,\r\n    description: 'Collection schema created successfully',\r\n  })\r\n  @ApiResponse({ status: 400, description: 'Invalid input or duplicate name' })\r\n  create(\r\n    @Body() createDto: CreateCollectionSchemaDto,\r\n    @DatabaseId() databaseId: string,\r\n    @Request() req,\r\n  ) {\r\n    // Override databaseId from header instead of body\r\n    const dto = { ...createDto, databaseId };\r\n    return this.collectionSchemaService.create(dto, req.user.userId);\r\n  }\r\n\r\n  @Get()\r\n  @ApiOperation({ summary: 'Get all collection schemas with pagination' })\r\n  @ApiQuery({ name: 'page', required: false, type: Number, example: 1 })\r\n  @ApiQuery({ name: 'limit', required: false, type: Number, example: 10 })\r\n  @ApiQuery({ name: 'search', required: false, type: String })\r\n  @ApiResponse({ status: 200, description: 'Collection schemas retrieved' })\r\n  findAll(\r\n    @Query() paginationDto: PaginationDto,\r\n    @DatabaseId() databaseId: string,\r\n    @Request() req,\r\n  ) {\r\n    return this.collectionSchemaService.findAll(\r\n      paginationDto,\r\n      req.user.userId,\r\n      databaseId,\r\n    );\r\n  }\r\n\r\n  @Get('all')\r\n  @ApiOperation({ summary: 'Get all collection schemas (paginated)' })\r\n  @ApiQuery({ name: 'page', required: false, type: Number, example: 1 })\r\n  @ApiQuery({ name: 'limit', required: false, type: Number, example: 10 })\r\n  @ApiQuery({ name: 'search', required: false, type: String })\r\n  @ApiResponse({ status: 200, description: 'Schemas retrieved (paginated)' })\r\n  findAllSchemas(\r\n    @Query() paginationDto: PaginationDto,\r\n    @DatabaseId() databaseId: string,\r\n    @Request() req,\r\n  ) {\r\n    return this.collectionSchemaService.findAll(\r\n      paginationDto,\r\n      req.user.userId,\r\n      databaseId,\r\n    );\r\n  }\r\n\r\n  @Get('by-name/:name')\r\n  @ApiOperation({ summary: 'Get collection schema by name' })\r\n  @ApiParam({\r\n    name: 'name',\r\n    example: 'products',\r\n    description: 'Collection name',\r\n  })\r\n  @ApiResponse({ status: 200, description: 'Schema found' })\r\n  @ApiResponse({ status: 404, description: 'Schema not found' })\r\n  async findByName(\r\n    @Param('name') name: string,\r\n    @DatabaseId() databaseId: string,\r\n    @Request() req,\r\n  ) {\r\n    const schema = await this.collectionSchemaService.findByName(\r\n      name,\r\n      req.user.userId,\r\n      databaseId,\r\n    );\r\n\r\n    if (!schema) {\r\n      throw new NotFoundException(\r\n        `Collection schema with name \"${name}\" not found`,\r\n      );\r\n    }\r\n\r\n    return schema;\r\n  }\r\n\r\n  @Get(':id')\r\n  @ApiOperation({ summary: 'Get collection schema by ID' })\r\n  @ApiResponse({ status: 200, description: 'Schema found' })\r\n  @ApiResponse({ status: 404, description: 'Schema not found' })\r\n  findOne(@Param('id') id: string, @Request() req) {\r\n    return this.collectionSchemaService.findById(id, req.user.userId);\r\n  }\r\n\r\n  @Patch(':id')\r\n  @ApiOperation({ summary: 'Update collection schema' })\r\n  @ApiResponse({ status: 200, description: 'Schema updated successfully' })\r\n  @ApiResponse({ status: 404, description: 'Schema not found' })\r\n  update(\r\n    @Param('id') id: string,\r\n    @Body() updateDto: UpdateCollectionSchemaDto,\r\n    @Request() req,\r\n  ) {\r\n    return this.collectionSchemaService.update(id, updateDto, req.user.userId);\r\n  }\r\n\r\n  @Delete(':id')\r\n  @ApiOperation({ summary: 'Delete collection schema' })\r\n  @ApiResponse({ status: 200, description: 'Schema deleted successfully' })\r\n  @ApiResponse({ status: 404, description: 'Schema not found' })\r\n  remove(@Param('id') id: string, @Request() req) {\r\n    return this.collectionSchemaService.remove(id, req.user.userId);\r\n  }\r\n\r\n  @Post('validate/:collectionName')\r\n  @ApiOperation({ summary: 'Validate data against schema' })\r\n  @ApiParam({ name: 'collectionName', example: 'products' })\r\n  @ApiBody({\r\n    description: 'Data to validate against the collection schema',\r\n    schema: {\r\n      type: 'object',\r\n      example: {\r\n        product_name: 'iPhone 15 Pro',\r\n        sku: 'IPHONE-15-PRO',\r\n        price: 999.99,\r\n        category: 'electronics',\r\n        in_stock: true,\r\n      },\r\n    },\r\n  })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Validation result returned',\r\n    schema: {\r\n      type: 'object',\r\n      properties: {\r\n        valid: { type: 'boolean', example: true },\r\n        errors: {\r\n          type: 'array',\r\n          items: { type: 'string' },\r\n          example: [],\r\n        },\r\n      },\r\n    },\r\n  })\r\n  validateData(\r\n    @Param('collectionName') collectionName: string,\r\n    @DatabaseId() databaseId: string,\r\n    @Body() data: Record<string, any>,\r\n    @Request() req,\r\n  ) {\r\n    return this.collectionSchemaService.validateData(\r\n      collectionName,\r\n      req.user.userId,\r\n      databaseId,\r\n      data,\r\n    );\r\n  }\r\n}\r\n"],"names":["CollectionSchemaController","create","createDto","databaseId","req","dto","collectionSchemaService","user","userId","findAll","paginationDto","findAllSchemas","findByName","name","schema","NotFoundException","findOne","id","findById","update","updateDto","remove","validateData","collectionName","data","summary","status","description","required","type","Number","example","String","product_name","sku","price","category","in_stock","properties","valid","errors","items","BASE"],"mappings":"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"}