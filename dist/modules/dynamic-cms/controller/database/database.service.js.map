{"version":3,"sources":["../../../../../src/modules/dynamic-cms/controller/database/database.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  ConflictException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, Types } from 'mongoose';\r\nimport { Database, DatabaseDocument } from '../../schemas/database.schema';\r\nimport {\r\n  CreateDatabaseDto,\r\n  UpdateDatabaseDto,\r\n  DatabaseResponseDto,\r\n} from '../../dto/database.dto';\r\nimport { PaginationDto } from '../../../../common/dto/pagination.dto';\r\n\r\n@Injectable()\r\nexport class DatabaseService {\r\n  constructor(\r\n    @InjectModel(Database.name)\r\n    private databaseModel: Model<DatabaseDocument>,\r\n  ) {}\r\n\r\n  /**\r\n   * Tạo database mới cho user\r\n   */\r\n  async create(\r\n    createDatabaseDto: CreateDatabaseDto,\r\n    userId: string,\r\n  ): Promise<DatabaseResponseDto> {\r\n    // Check if database name already exists for this user\r\n    const existing = await this.databaseModel\r\n      .findOne({\r\n        userId: new Types.ObjectId(userId),\r\n        name: createDatabaseDto.name,\r\n      })\r\n      .exec();\r\n\r\n    if (existing) {\r\n      throw new ConflictException(\r\n        `Database with name \"${createDatabaseDto.name}\" already exists`,\r\n      );\r\n    }\r\n\r\n    const database = new this.databaseModel({\r\n      ...createDatabaseDto,\r\n      userId: new Types.ObjectId(userId),\r\n      createdBy: userId,\r\n    });\r\n\r\n    const saved = await database.save();\r\n    return this.toResponseDto(saved);\r\n  }\r\n\r\n  /**\r\n   * Lấy tất cả databases của user với phân trang\r\n   */\r\n  async findAllByUser(\r\n    userId: string,\r\n    paginationDto: PaginationDto,\r\n  ): Promise<any> {\r\n    const { page = 1, limit = 10, search } = paginationDto;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const query: any = { userId: new Types.ObjectId(userId) };\r\n\r\n    if (search) {\r\n      query.$or = [\r\n        { name: { $regex: search, $options: 'i' } },\r\n        { displayName: { $regex: search, $options: 'i' } },\r\n        { description: { $regex: search, $options: 'i' } },\r\n      ];\r\n    }\r\n\r\n    const [data, total] = await Promise.all([\r\n      this.databaseModel\r\n        .find(query)\r\n        .sort({ createdAt: -1 })\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .exec(),\r\n      this.databaseModel.countDocuments(query).exec(),\r\n    ]);\r\n\r\n    return {\r\n      data: data.map((db) => this.toResponseDto(db)),\r\n      total,\r\n      page,\r\n      limit,\r\n      totalPages: Math.ceil(total / limit),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Lấy database theo ID và kiểm tra ownership\r\n   */\r\n  async findOne(id: string, userId: string): Promise<DatabaseResponseDto> {\r\n    const database = await this.databaseModel.findById(id).exec();\r\n\r\n    if (!database) {\r\n      throw new NotFoundException(`Database with ID \"${id}\" not found`);\r\n    }\r\n\r\n    // Check ownership\r\n    if (database.userId.toString() !== userId) {\r\n      throw new ForbiddenException('You do not have access to this database');\r\n    }\r\n\r\n    return this.toResponseDto(database);\r\n  }\r\n\r\n  /**\r\n   * Cập nhật database\r\n   */\r\n  async update(\r\n    id: string,\r\n    updateDatabaseDto: UpdateDatabaseDto,\r\n    userId: string,\r\n  ): Promise<DatabaseResponseDto> {\r\n    const database = await this.databaseModel.findById(id).exec();\r\n\r\n    if (!database) {\r\n      throw new NotFoundException(`Database with ID \"${id}\" not found`);\r\n    }\r\n\r\n    // Check ownership\r\n    if (database.userId.toString() !== userId) {\r\n      throw new ForbiddenException('You do not have access to this database');\r\n    }\r\n\r\n    // Check name uniqueness if changing name\r\n    if (updateDatabaseDto.name && updateDatabaseDto.name !== database.name) {\r\n      const existing = await this.databaseModel\r\n        .findOne({\r\n          userId: new Types.ObjectId(userId),\r\n          name: updateDatabaseDto.name,\r\n          _id: { $ne: id },\r\n        })\r\n        .exec();\r\n\r\n      if (existing) {\r\n        throw new ConflictException(\r\n          `Database with name \"${updateDatabaseDto.name}\" already exists`,\r\n        );\r\n      }\r\n    }\r\n\r\n    Object.assign(database, updateDatabaseDto);\r\n    database.updatedBy = userId;\r\n    const updated = await database.save();\r\n\r\n    return this.toResponseDto(updated);\r\n  }\r\n\r\n  /**\r\n   * Xóa database (soft delete - chỉ set isActive = false)\r\n   */\r\n  async remove(id: string, userId: string): Promise<{ message: string }> {\r\n    const database = await this.databaseModel.findById(id).exec();\r\n\r\n    if (!database) {\r\n      throw new NotFoundException(`Database with ID \"${id}\" not found`);\r\n    }\r\n\r\n    // Check ownership\r\n    if (database.userId.toString() !== userId) {\r\n      throw new ForbiddenException('You do not have access to this database');\r\n    }\r\n\r\n    database.isActive = false;\r\n    database.updatedBy = userId;\r\n    await database.save();\r\n\r\n    return { message: 'Database deactivated successfully' };\r\n  }\r\n\r\n  /**\r\n   * Xóa database vĩnh viễn (hard delete)\r\n   */\r\n  async permanentDelete(\r\n    id: string,\r\n    userId: string,\r\n  ): Promise<{ message: string }> {\r\n    const database = await this.databaseModel.findById(id).exec();\r\n\r\n    if (!database) {\r\n      throw new NotFoundException(`Database with ID \"${id}\" not found`);\r\n    }\r\n\r\n    // Check ownership\r\n    if (database.userId.toString() !== userId) {\r\n      throw new ForbiddenException('You do not have access to this database');\r\n    }\r\n\r\n    await this.databaseModel.findByIdAndDelete(id).exec();\r\n\r\n    return { message: 'Database permanently deleted' };\r\n  }\r\n\r\n  /**\r\n   * Cập nhật số lượng collections và data\r\n   */\r\n  async updateCounts(\r\n    databaseId: string,\r\n    collectionsCount?: number,\r\n    dataCount?: number,\r\n  ): Promise<void> {\r\n    const update: any = {};\r\n    if (collectionsCount !== undefined)\r\n      update.collectionsCount = collectionsCount;\r\n    if (dataCount !== undefined) update.dataCount = dataCount;\r\n\r\n    await this.databaseModel.findByIdAndUpdate(databaseId, update).exec();\r\n  }\r\n\r\n  /**\r\n   * Convert document to response DTO\r\n   */\r\n  private toResponseDto(database: any): DatabaseResponseDto {\r\n    return {\r\n      id: database._id.toString(),\r\n      name: database.name,\r\n      displayName: database.displayName,\r\n      description: database.description,\r\n      userId: database.userId.toString(),\r\n      isActive: database.isActive,\r\n      icon: database.icon,\r\n      settings: database.settings,\r\n      tags: database.tags,\r\n      collectionsCount: database.collectionsCount || 0,\r\n      dataCount: database.dataCount || 0,\r\n      createdAt: database.createdAt,\r\n      updatedAt: database.updatedAt,\r\n    };\r\n  }\r\n}\r\n"],"names":["DatabaseService","create","createDatabaseDto","userId","existing","databaseModel","findOne","Types","ObjectId","name","exec","ConflictException","database","createdBy","saved","save","toResponseDto","findAllByUser","paginationDto","page","limit","search","skip","query","$or","$regex","$options","displayName","description","data","total","Promise","all","find","sort","createdAt","countDocuments","map","db","totalPages","Math","ceil","id","findById","NotFoundException","toString","ForbiddenException","update","updateDatabaseDto","_id","$ne","Object","assign","updatedBy","updated","remove","isActive","message","permanentDelete","findByIdAndDelete","updateCounts","databaseId","collectionsCount","dataCount","undefined","findByIdAndUpdate","icon","settings","tags","updatedAt"],"mappings":"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"}