{"version":3,"sources":["../../../src/modules/content/content.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model } from 'mongoose';\r\nimport { Content, ContentDocument } from './schemas/content.schema';\r\nimport { CreateContentDto, UpdateContentDto } from './dto/content.dto';\r\nimport {\r\n  PaginationDto,\r\n  PaginationResponse,\r\n} from '../../common/dto/pagination.dto';\r\n\r\n@Injectable()\r\nexport class ContentService {\r\n  constructor(\r\n    @InjectModel(Content.name) private contentModel: Model<ContentDocument>,\r\n  ) {}\r\n\r\n  async create(createContentDto: CreateContentDto): Promise<Content> {\r\n    const createdContent = new this.contentModel(createContentDto);\r\n    return createdContent.save();\r\n  }\r\n\r\n  async findAll(\r\n    paginationDto: PaginationDto,\r\n  ): Promise<PaginationResponse<Content>> {\r\n    const { page = 1, limit = 10, search } = paginationDto;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const query = search\r\n      ? {\r\n          $or: [\r\n            { title: { $regex: search, $options: 'i' } },\r\n            { excerpt: { $regex: search, $options: 'i' } },\r\n            { tags: { $in: [new RegExp(search, 'i')] } },\r\n          ],\r\n        }\r\n      : {};\r\n\r\n    const [data, total] = await Promise.all([\r\n      this.contentModel\r\n        .find(query)\r\n        .populate('author', 'firstName lastName email')\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .sort({ createdAt: -1 })\r\n        .exec(),\r\n      this.contentModel.countDocuments(query).exec(),\r\n    ]);\r\n\r\n    return {\r\n      data,\r\n      total,\r\n      page,\r\n      limit,\r\n      totalPages: Math.ceil(total / limit),\r\n    };\r\n  }\r\n\r\n  async findOne(id: string): Promise<Content | null> {\r\n    return this.contentModel\r\n      .findById(id)\r\n      .populate('author', 'firstName lastName email')\r\n      .exec();\r\n  }\r\n\r\n  async findBySlug(slug: string): Promise<Content | null> {\r\n    return this.contentModel\r\n      .findOne({ slug })\r\n      .populate('author', 'firstName lastName email')\r\n      .exec();\r\n  }\r\n\r\n  async findByStatus(status: string): Promise<Content[]> {\r\n    return this.contentModel\r\n      .find({ status })\r\n      .populate('author', 'firstName lastName email')\r\n      .exec();\r\n  }\r\n\r\n  async update(\r\n    id: string,\r\n    updateContentDto: UpdateContentDto,\r\n  ): Promise<Content | null> {\r\n    if (updateContentDto.status === 'published') {\r\n      updateContentDto['publishedAt'] = new Date();\r\n    }\r\n\r\n    return this.contentModel\r\n      .findByIdAndUpdate(id, updateContentDto, { new: true })\r\n      .populate('author', 'firstName lastName email')\r\n      .exec();\r\n  }\r\n\r\n  async incrementViewCount(id: string): Promise<Content | null> {\r\n    return this.contentModel\r\n      .findByIdAndUpdate(id, { $inc: { viewCount: 1 } }, { new: true })\r\n      .exec();\r\n  }\r\n\r\n  async remove(id: string): Promise<Content | null> {\r\n    return this.contentModel.findByIdAndDelete(id).exec();\r\n  }\r\n}\r\n"],"names":["ContentService","create","createContentDto","createdContent","contentModel","save","findAll","paginationDto","page","limit","search","skip","query","$or","title","$regex","$options","excerpt","tags","$in","RegExp","data","total","Promise","all","find","populate","sort","createdAt","exec","countDocuments","totalPages","Math","ceil","findOne","id","findById","findBySlug","slug","findByStatus","status","update","updateContentDto","Date","findByIdAndUpdate","new","incrementViewCount","$inc","viewCount","remove","findByIdAndDelete","name"],"mappings":";;;;+BAWaA;;;eAAAA;;;wBAXc;0BACC;2BACN;+BACmB;;;;;;;;;;;;;;;AAQlC,IAAA,AAAMA,iBAAN,MAAMA;IAKX,MAAMC,OAAOC,gBAAkC,EAAoB;QACjE,MAAMC,iBAAiB,IAAI,IAAI,CAACC,YAAY,CAACF;QAC7C,OAAOC,eAAeE,IAAI;IAC5B;IAEA,MAAMC,QACJC,aAA4B,EACU;QACtC,MAAM,EAAEC,OAAO,CAAC,EAAEC,QAAQ,EAAE,EAAEC,MAAM,EAAE,GAAGH;QACzC,MAAMI,OAAO,AAACH,CAAAA,OAAO,CAAA,IAAKC;QAE1B,MAAMG,QAAQF,SACV;YACEG,KAAK;gBACH;oBAAEC,OAAO;wBAAEC,QAAQL;wBAAQM,UAAU;oBAAI;gBAAE;gBAC3C;oBAAEC,SAAS;wBAAEF,QAAQL;wBAAQM,UAAU;oBAAI;gBAAE;gBAC7C;oBAAEE,MAAM;wBAAEC,KAAK;4BAAC,IAAIC,OAAOV,QAAQ;yBAAK;oBAAC;gBAAE;aAC5C;QACH,IACA,CAAC;QAEL,MAAM,CAACW,MAAMC,MAAM,GAAG,MAAMC,QAAQC,GAAG,CAAC;YACtC,IAAI,CAACpB,YAAY,CACdqB,IAAI,CAACb,OACLc,QAAQ,CAAC,UAAU,4BACnBf,IAAI,CAACA,MACLF,KAAK,CAACA,OACNkB,IAAI,CAAC;gBAAEC,WAAW,CAAC;YAAE,GACrBC,IAAI;YACP,IAAI,CAACzB,YAAY,CAAC0B,cAAc,CAAClB,OAAOiB,IAAI;SAC7C;QAED,OAAO;YACLR;YACAC;YACAd;YACAC;YACAsB,YAAYC,KAAKC,IAAI,CAACX,QAAQb;QAChC;IACF;IAEA,MAAMyB,QAAQC,EAAU,EAA2B;QACjD,OAAO,IAAI,CAAC/B,YAAY,CACrBgC,QAAQ,CAACD,IACTT,QAAQ,CAAC,UAAU,4BACnBG,IAAI;IACT;IAEA,MAAMQ,WAAWC,IAAY,EAA2B;QACtD,OAAO,IAAI,CAAClC,YAAY,CACrB8B,OAAO,CAAC;YAAEI;QAAK,GACfZ,QAAQ,CAAC,UAAU,4BACnBG,IAAI;IACT;IAEA,MAAMU,aAAaC,MAAc,EAAsB;QACrD,OAAO,IAAI,CAACpC,YAAY,CACrBqB,IAAI,CAAC;YAAEe;QAAO,GACdd,QAAQ,CAAC,UAAU,4BACnBG,IAAI;IACT;IAEA,MAAMY,OACJN,EAAU,EACVO,gBAAkC,EACT;QACzB,IAAIA,iBAAiBF,MAAM,KAAK,aAAa;YAC3CE,gBAAgB,CAAC,cAAc,GAAG,IAAIC;QACxC;QAEA,OAAO,IAAI,CAACvC,YAAY,CACrBwC,iBAAiB,CAACT,IAAIO,kBAAkB;YAAEG,KAAK;QAAK,GACpDnB,QAAQ,CAAC,UAAU,4BACnBG,IAAI;IACT;IAEA,MAAMiB,mBAAmBX,EAAU,EAA2B;QAC5D,OAAO,IAAI,CAAC/B,YAAY,CACrBwC,iBAAiB,CAACT,IAAI;YAAEY,MAAM;gBAAEC,WAAW;YAAE;QAAE,GAAG;YAAEH,KAAK;QAAK,GAC9DhB,IAAI;IACT;IAEA,MAAMoB,OAAOd,EAAU,EAA2B;QAChD,OAAO,IAAI,CAAC/B,YAAY,CAAC8C,iBAAiB,CAACf,IAAIN,IAAI;IACrD;IAxFA,YACE,AAAmCzB,YAAoC,CACvE;aADmCA,eAAAA;IAClC;AAuFL;;;mEAxFyB+C"}