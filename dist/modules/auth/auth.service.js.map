{"version":3,"sources":["../../../src/modules/auth/auth.service.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model } from 'mongoose';\r\nimport { User, UserDocument } from '../users/schemas/user.schema';\r\nimport {\r\n  LoginRequestDto,\r\n  RegisterRequestDto,\r\n  RefreshTokenRequestDto,\r\n} from './dto/auth-request.dto';\r\nimport { LoginHandler } from './handlers/login.handler';\r\nimport { RegisterHandler } from './handlers/register.handler';\r\nimport { RefreshTokenHandler } from './handlers/refresh-token.handler';\r\nimport { LogoutHandler } from './handlers/logout.handler';\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  constructor(\r\n    @InjectModel(User.name) private userModel: Model<UserDocument>,\r\n    private loginHandler: LoginHandler,\r\n    private registerHandler: RegisterHandler,\r\n    private refreshTokenHandler: RefreshTokenHandler,\r\n    private logoutHandler: LogoutHandler,\r\n  ) {}\r\n\r\n  async login(loginDto: LoginRequestDto) {\r\n    // Find user by email or username\r\n    const user = await this.userModel\r\n      .findOne({\r\n        $or: [\r\n          { email: loginDto.emailOrUsername },\r\n          { userName: loginDto.emailOrUsername },\r\n        ],\r\n      })\r\n      .exec();\r\n\r\n    if (!user) {\r\n      throw new UnauthorizedException('Invalid credentials');\r\n    }\r\n\r\n    // Validate password\r\n    const isPasswordValid = await this.loginHandler.validatePassword(\r\n      loginDto.password,\r\n      user.password,\r\n    );\r\n\r\n    if (!isPasswordValid) {\r\n      throw new UnauthorizedException('Invalid credentials');\r\n    }\r\n\r\n    if (!user.isActive) {\r\n      throw new UnauthorizedException('Account is inactive');\r\n    }\r\n\r\n    // Update last login\r\n    user.lastLogin = new Date();\r\n    await user.save();\r\n\r\n    // Generate tokens\r\n    return this.loginHandler.execute(user);\r\n  }\r\n\r\n  async register(registerDto: RegisterRequestDto) {\r\n    return this.registerHandler.execute(registerDto);\r\n  }\r\n\r\n  async refreshToken(refreshTokenDto: RefreshTokenRequestDto) {\r\n    return this.refreshTokenHandler.execute(refreshTokenDto.refreshToken);\r\n  }\r\n\r\n  async logout(refreshToken: string) {\r\n    return this.logoutHandler.execute(refreshToken);\r\n  }\r\n\r\n  async validateUser(userId: string): Promise<User | null> {\r\n    return this.userModel.findById(userId).exec();\r\n  }\r\n}\r\n"],"names":["AuthService","login","loginDto","user","userModel","findOne","$or","email","emailOrUsername","userName","exec","UnauthorizedException","isPasswordValid","loginHandler","validatePassword","password","isActive","lastLogin","Date","save","execute","register","registerDto","registerHandler","refreshToken","refreshTokenDto","refreshTokenHandler","logout","logoutHandler","validateUser","userId","findById","name"],"mappings":";;;;+BAeaA;;;eAAAA;;;wBAfqC;0BACtB;2BACN;4BACa;8BAMN;iCACG;qCACI;+BACN;;;;;;;;;;;;;;;AAGvB,IAAA,AAAMA,cAAN,MAAMA;IASX,MAAMC,MAAMC,QAAyB,EAAE;QACrC,iCAAiC;QACjC,MAAMC,OAAO,MAAM,IAAI,CAACC,SAAS,CAC9BC,OAAO,CAAC;YACPC,KAAK;gBACH;oBAAEC,OAAOL,SAASM,eAAe;gBAAC;gBAClC;oBAAEC,UAAUP,SAASM,eAAe;gBAAC;aACtC;QACH,GACCE,IAAI;QAEP,IAAI,CAACP,MAAM;YACT,MAAM,IAAIQ,6BAAqB,CAAC;QAClC;QAEA,oBAAoB;QACpB,MAAMC,kBAAkB,MAAM,IAAI,CAACC,YAAY,CAACC,gBAAgB,CAC9DZ,SAASa,QAAQ,EACjBZ,KAAKY,QAAQ;QAGf,IAAI,CAACH,iBAAiB;YACpB,MAAM,IAAID,6BAAqB,CAAC;QAClC;QAEA,IAAI,CAACR,KAAKa,QAAQ,EAAE;YAClB,MAAM,IAAIL,6BAAqB,CAAC;QAClC;QAEA,oBAAoB;QACpBR,KAAKc,SAAS,GAAG,IAAIC;QACrB,MAAMf,KAAKgB,IAAI;QAEf,kBAAkB;QAClB,OAAO,IAAI,CAACN,YAAY,CAACO,OAAO,CAACjB;IACnC;IAEA,MAAMkB,SAASC,WAA+B,EAAE;QAC9C,OAAO,IAAI,CAACC,eAAe,CAACH,OAAO,CAACE;IACtC;IAEA,MAAME,aAAaC,eAAuC,EAAE;QAC1D,OAAO,IAAI,CAACC,mBAAmB,CAACN,OAAO,CAACK,gBAAgBD,YAAY;IACtE;IAEA,MAAMG,OAAOH,YAAoB,EAAE;QACjC,OAAO,IAAI,CAACI,aAAa,CAACR,OAAO,CAACI;IACpC;IAEA,MAAMK,aAAaC,MAAc,EAAwB;QACvD,OAAO,IAAI,CAAC1B,SAAS,CAAC2B,QAAQ,CAACD,QAAQpB,IAAI;IAC7C;IA3DA,YACE,AAAgCN,SAA8B,EAC9D,AAAQS,YAA0B,EAClC,AAAQU,eAAgC,EACxC,AAAQG,mBAAwC,EAChD,AAAQE,aAA4B,CACpC;aALgCxB,YAAAA;aACxBS,eAAAA;aACAU,kBAAAA;aACAG,sBAAAA;aACAE,gBAAAA;IACP;AAsDL;;;6DA3DsBI"}