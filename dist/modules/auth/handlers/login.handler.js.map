{"version":3,"sources":["../../../../src/modules/auth/handlers/login.handler.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport * as bcrypt from 'bcrypt';\r\nimport { User } from '../../users/schemas/user.schema';\r\n\r\n@Injectable()\r\nexport class LoginHandler {\r\n  constructor(private jwtService: JwtService) {}\r\n\r\n  async execute(user: any) {\r\n    const payload = {\r\n      sub: user._id.toString(),\r\n      email: user.email,\r\n      userName: user.userName,\r\n      role: user.role,\r\n    };\r\n\r\n    // Set tokens to expire in 1 year (seconds)\r\n    const ONE_YEAR_SECONDS = 365 * 24 * 60 * 60; // 31536000\r\n\r\n    const accessToken = this.jwtService.sign(payload, {\r\n      expiresIn: ONE_YEAR_SECONDS,\r\n    });\r\n\r\n    const refreshToken = this.jwtService.sign(payload, {\r\n      expiresIn: ONE_YEAR_SECONDS,\r\n    });\r\n\r\n    return {\r\n      accessToken,\r\n      refreshToken,\r\n      userProfile: {\r\n        id: user._id.toString(),\r\n        email: user.email,\r\n        userName: user.userName,\r\n        firstName: user.firstName,\r\n        lastName: user.lastName,\r\n        role: user.role,\r\n        isActive: user.isActive,\r\n        avatar: user.avatar,\r\n        points: user.points,\r\n        walletBalance: user.walletBalance,\r\n        lastLogin: user.lastLogin,\r\n      },\r\n      expiresIn: ONE_YEAR_SECONDS,\r\n    };\r\n  }\r\n\r\n  async validatePassword(\r\n    plainPassword: string,\r\n    hashedPassword: string,\r\n  ): Promise<boolean> {\r\n    return bcrypt.compare(plainPassword, hashedPassword);\r\n  }\r\n}\r\n"],"names":["LoginHandler","execute","user","payload","sub","_id","toString","email","userName","role","ONE_YEAR_SECONDS","accessToken","jwtService","sign","expiresIn","refreshToken","userProfile","id","firstName","lastName","isActive","avatar","points","walletBalance","lastLogin","validatePassword","plainPassword","hashedPassword","bcrypt","compare"],"mappings":";;;;+BAMaA;;;eAAAA;;;wBANqC;qBACvB;gEACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIjB,IAAA,AAAMA,eAAN,MAAMA;IAGX,MAAMC,QAAQC,IAAS,EAAE;QACvB,MAAMC,UAAU;YACdC,KAAKF,KAAKG,GAAG,CAACC,QAAQ;YACtBC,OAAOL,KAAKK,KAAK;YACjBC,UAAUN,KAAKM,QAAQ;YACvBC,MAAMP,KAAKO,IAAI;QACjB;QAEA,2CAA2C;QAC3C,MAAMC,mBAAmB,MAAM,KAAK,KAAK,IAAI,WAAW;QAExD,MAAMC,cAAc,IAAI,CAACC,UAAU,CAACC,IAAI,CAACV,SAAS;YAChDW,WAAWJ;QACb;QAEA,MAAMK,eAAe,IAAI,CAACH,UAAU,CAACC,IAAI,CAACV,SAAS;YACjDW,WAAWJ;QACb;QAEA,OAAO;YACLC;YACAI;YACAC,aAAa;gBACXC,IAAIf,KAAKG,GAAG,CAACC,QAAQ;gBACrBC,OAAOL,KAAKK,KAAK;gBACjBC,UAAUN,KAAKM,QAAQ;gBACvBU,WAAWhB,KAAKgB,SAAS;gBACzBC,UAAUjB,KAAKiB,QAAQ;gBACvBV,MAAMP,KAAKO,IAAI;gBACfW,UAAUlB,KAAKkB,QAAQ;gBACvBC,QAAQnB,KAAKmB,MAAM;gBACnBC,QAAQpB,KAAKoB,MAAM;gBACnBC,eAAerB,KAAKqB,aAAa;gBACjCC,WAAWtB,KAAKsB,SAAS;YAC3B;YACAV,WAAWJ;QACb;IACF;IAEA,MAAMe,iBACJC,aAAqB,EACrBC,cAAsB,EACJ;QAClB,OAAOC,QAAOC,OAAO,CAACH,eAAeC;IACvC;IA9CA,YAAY,AAAQf,UAAsB,CAAE;aAAxBA,aAAAA;IAAyB;AA+C/C"}