{"version":3,"sources":["../../../../src/modules/auth/handlers/logout.handler.ts"],"sourcesContent":["import { Injectable, BadRequestException } from '@nestjs/common';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model } from 'mongoose';\r\nimport {\r\n  BlacklistedToken,\r\n  BlacklistedTokenDocument,\r\n} from '../schemas/blacklisted-token.schema';\r\n\r\n@Injectable()\r\nexport class LogoutHandler {\r\n  constructor(\r\n    private jwtService: JwtService,\r\n    @InjectModel(BlacklistedToken.name)\r\n    private blacklistedModel: Model<BlacklistedTokenDocument>,\r\n  ) {}\r\n\r\n  async execute(refreshToken: string) {\r\n    if (!refreshToken) {\r\n      throw new BadRequestException('Refresh token is required');\r\n    }\r\n\r\n    // Try to decode token to determine expiry\r\n    try {\r\n      const payload: any = this.jwtService.verify(refreshToken, {\r\n        ignoreExpiration: true,\r\n      });\r\n\r\n      // Calculate expiry date from exp claim if present\r\n      const expiresAt = payload?.exp\r\n        ? new Date(payload.exp * 1000)\r\n        : new Date(Date.now() + 7 * 24 * 3600 * 1000);\r\n\r\n      // Store in blacklist (upsert to avoid duplicates)\r\n      await this.blacklistedModel\r\n        .updateOne(\r\n          { token: refreshToken },\r\n          { token: refreshToken, expiresAt },\r\n          { upsert: true },\r\n        )\r\n        .exec();\r\n\r\n      return { success: true, message: 'Logged out successfully' };\r\n    } catch (err) {\r\n      // If token invalid, still respond success so callers can clear local tokens\r\n      await this.blacklistedModel\r\n        .updateOne(\r\n          { token: refreshToken },\r\n          {\r\n            token: refreshToken,\r\n            expiresAt: new Date(Date.now() + 60 * 60 * 1000),\r\n          },\r\n          { upsert: true },\r\n        )\r\n        .exec();\r\n      return { success: true, message: 'Logged out successfully' };\r\n    }\r\n  }\r\n}\r\n"],"names":["LogoutHandler","execute","refreshToken","BadRequestException","payload","jwtService","verify","ignoreExpiration","expiresAt","exp","Date","now","blacklistedModel","updateOne","token","upsert","exec","success","message","err","name"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAVmC;qBACrB;0BACC;2BACN;wCAIf;;;;;;;;;;;;;;;AAGA,IAAA,AAAMA,gBAAN,MAAMA;IAOX,MAAMC,QAAQC,YAAoB,EAAE;QAClC,IAAI,CAACA,cAAc;YACjB,MAAM,IAAIC,2BAAmB,CAAC;QAChC;QAEA,0CAA0C;QAC1C,IAAI;YACF,MAAMC,UAAe,IAAI,CAACC,UAAU,CAACC,MAAM,CAACJ,cAAc;gBACxDK,kBAAkB;YACpB;YAEA,kDAAkD;YAClD,MAAMC,YAAYJ,SAASK,MACvB,IAAIC,KAAKN,QAAQK,GAAG,GAAG,QACvB,IAAIC,KAAKA,KAAKC,GAAG,KAAK,IAAI,KAAK,OAAO;YAE1C,kDAAkD;YAClD,MAAM,IAAI,CAACC,gBAAgB,CACxBC,SAAS,CACR;gBAAEC,OAAOZ;YAAa,GACtB;gBAAEY,OAAOZ;gBAAcM;YAAU,GACjC;gBAAEO,QAAQ;YAAK,GAEhBC,IAAI;YAEP,OAAO;gBAAEC,SAAS;gBAAMC,SAAS;YAA0B;QAC7D,EAAE,OAAOC,KAAK;YACZ,4EAA4E;YAC5E,MAAM,IAAI,CAACP,gBAAgB,CACxBC,SAAS,CACR;gBAAEC,OAAOZ;YAAa,GACtB;gBACEY,OAAOZ;gBACPM,WAAW,IAAIE,KAAKA,KAAKC,GAAG,KAAK,KAAK,KAAK;YAC7C,GACA;gBAAEI,QAAQ;YAAK,GAEhBC,IAAI;YACP,OAAO;gBAAEC,SAAS;gBAAMC,SAAS;YAA0B;QAC7D;IACF;IA9CA,YACE,AAAQb,UAAsB,EAC9B,AACQO,gBAAiD,CACzD;aAHQP,aAAAA;aAEAO,mBAAAA;IACP;AA2CL;;;qFA7CkCQ"}