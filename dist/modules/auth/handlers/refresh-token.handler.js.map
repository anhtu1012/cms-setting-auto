{"version":3,"sources":["../../../../src/modules/auth/handlers/refresh-token.handler.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model } from 'mongoose';\r\nimport {\r\n  BlacklistedToken,\r\n  BlacklistedTokenDocument,\r\n} from '../schemas/blacklisted-token.schema';\r\n\r\n@Injectable()\r\nexport class RefreshTokenHandler {\r\n  constructor(\r\n    private jwtService: JwtService,\r\n    @InjectModel(BlacklistedToken.name)\r\n    private blacklistedModel: Model<BlacklistedTokenDocument>,\r\n  ) {}\r\n\r\n  async execute(refreshToken: string) {\r\n    // Check if token is blacklisted\r\n    const found = await this.blacklistedModel\r\n      .findOne({ token: refreshToken })\r\n      .exec();\r\n    if (found) {\r\n      throw new UnauthorizedException('Refresh token has been revoked');\r\n    }\r\n\r\n    try {\r\n      const payload = this.jwtService.verify(refreshToken);\r\n\r\n      const ONE_YEAR_SECONDS = 365 * 24 * 60 * 60; // 31536000\r\n\r\n      const newAccessToken = this.jwtService.sign(\r\n        {\r\n          sub: payload.sub,\r\n          email: payload.email,\r\n          userName: payload.userName,\r\n          role: payload.role,\r\n        },\r\n        { expiresIn: ONE_YEAR_SECONDS },\r\n      );\r\n\r\n      const newRefreshToken = this.jwtService.sign(\r\n        {\r\n          sub: payload.sub,\r\n          email: payload.email,\r\n          userName: payload.userName,\r\n          role: payload.role,\r\n        },\r\n        { expiresIn: ONE_YEAR_SECONDS },\r\n      );\r\n\r\n      return {\r\n        accessToken: newAccessToken,\r\n        refreshToken: newRefreshToken,\r\n        expiresIn: ONE_YEAR_SECONDS,\r\n      };\r\n    } catch (error) {\r\n      throw new UnauthorizedException('Invalid or expired refresh token');\r\n    }\r\n  }\r\n}\r\n"],"names":["RefreshTokenHandler","execute","refreshToken","found","blacklistedModel","findOne","token","exec","UnauthorizedException","payload","jwtService","verify","ONE_YEAR_SECONDS","newAccessToken","sign","sub","email","userName","role","expiresIn","newRefreshToken","accessToken","error","name"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAVqC;qBACvB;0BACC;2BACN;wCAIf;;;;;;;;;;;;;;;AAGA,IAAA,AAAMA,sBAAN,MAAMA;IAOX,MAAMC,QAAQC,YAAoB,EAAE;QAClC,gCAAgC;QAChC,MAAMC,QAAQ,MAAM,IAAI,CAACC,gBAAgB,CACtCC,OAAO,CAAC;YAAEC,OAAOJ;QAAa,GAC9BK,IAAI;QACP,IAAIJ,OAAO;YACT,MAAM,IAAIK,6BAAqB,CAAC;QAClC;QAEA,IAAI;YACF,MAAMC,UAAU,IAAI,CAACC,UAAU,CAACC,MAAM,CAACT;YAEvC,MAAMU,mBAAmB,MAAM,KAAK,KAAK,IAAI,WAAW;YAExD,MAAMC,iBAAiB,IAAI,CAACH,UAAU,CAACI,IAAI,CACzC;gBACEC,KAAKN,QAAQM,GAAG;gBAChBC,OAAOP,QAAQO,KAAK;gBACpBC,UAAUR,QAAQQ,QAAQ;gBAC1BC,MAAMT,QAAQS,IAAI;YACpB,GACA;gBAAEC,WAAWP;YAAiB;YAGhC,MAAMQ,kBAAkB,IAAI,CAACV,UAAU,CAACI,IAAI,CAC1C;gBACEC,KAAKN,QAAQM,GAAG;gBAChBC,OAAOP,QAAQO,KAAK;gBACpBC,UAAUR,QAAQQ,QAAQ;gBAC1BC,MAAMT,QAAQS,IAAI;YACpB,GACA;gBAAEC,WAAWP;YAAiB;YAGhC,OAAO;gBACLS,aAAaR;gBACbX,cAAckB;gBACdD,WAAWP;YACb;QACF,EAAE,OAAOU,OAAO;YACd,MAAM,IAAId,6BAAqB,CAAC;QAClC;IACF;IAhDA,YACE,AAAQE,UAAsB,EAC9B,AACQN,gBAAiD,CACzD;aAHQM,aAAAA;aAEAN,mBAAAA;IACP;AA6CL;;;qFA/CkCmB"}