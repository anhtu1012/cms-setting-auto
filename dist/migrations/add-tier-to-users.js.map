{"version":3,"sources":["../../src/migrations/add-tier-to-users.ts"],"sourcesContent":["import { MongoClient } from 'mongodb';\r\n\r\n/**\r\n * Migration script Ä‘á»ƒ thÃªm tier fields cho cÃ¡c user hiá»‡n cÃ³\r\n * Run: npx ts-node src/migrations/add-tier-to-users.ts\r\n */\r\n\r\nconst MONGODB_URI =\r\n  process.env.MONGODB_URI || 'mongodb://localhost:27017/cms-setting-auto';\r\n\r\nasync function migrateTierFields() {\r\n  const client = new MongoClient(MONGODB_URI);\r\n\r\n  try {\r\n    await client.connect();\r\n    console.log('âœ… Connected to MongoDB');\r\n\r\n    const db = client.db();\r\n    const usersCollection = db.collection('users');\r\n\r\n    // Äáº¿m users khÃ´ng cÃ³ tier field\r\n    const usersWithoutTier = await usersCollection.countDocuments({\r\n      tier: { $exists: false },\r\n    });\r\n\r\n    console.log(`ðŸ“Š Found ${usersWithoutTier} users without tier field`);\r\n\r\n    if (usersWithoutTier === 0) {\r\n      console.log('âœ… All users already have tier field. Nothing to migrate.');\r\n      return;\r\n    }\r\n\r\n    // Update users without tier field\r\n    const result = await usersCollection.updateMany(\r\n      { tier: { $exists: false } },\r\n      {\r\n        $set: {\r\n          tier: 'free', // Default tier\r\n          tierStartDate: new Date(),\r\n          currentDatabaseCount: 0,\r\n          apiCallsToday: 0,\r\n          tierHistory: [],\r\n        },\r\n      },\r\n    );\r\n\r\n    console.log(`âœ… Updated ${result.modifiedCount} users with tier fields`);\r\n\r\n    // Verify results\r\n    const updatedUsers = await usersCollection\r\n      .find({ tier: 'free' })\r\n      .limit(3)\r\n      .toArray();\r\n\r\n    console.log('\\nðŸ“ Sample updated users:');\r\n    updatedUsers.forEach((user) => {\r\n      console.log(`  - ${user.email}: tier=${user.tier}`);\r\n    });\r\n\r\n    console.log('\\nâœ… Migration completed successfully!');\r\n  } catch (error) {\r\n    console.error('âŒ Migration failed:', error);\r\n    throw error;\r\n  } finally {\r\n    await client.close();\r\n    console.log('ðŸ”Œ Disconnected from MongoDB');\r\n  }\r\n}\r\n\r\n// Run migration\r\nmigrateTierFields()\r\n  .then(() => {\r\n    console.log('\\nðŸŽ‰ Done!');\r\n    process.exit(0);\r\n  })\r\n  .catch((error) => {\r\n    console.error('\\nðŸ’¥ Error:', error);\r\n    process.exit(1);\r\n  });\r\n"],"names":["MONGODB_URI","process","env","migrateTierFields","client","MongoClient","connect","console","log","db","usersCollection","collection","usersWithoutTier","countDocuments","tier","$exists","result","updateMany","$set","tierStartDate","Date","currentDatabaseCount","apiCallsToday","tierHistory","modifiedCount","updatedUsers","find","limit","toArray","forEach","user","email","error","close","then","exit","catch"],"mappings":";;;;yBAA4B;AAE5B;;;CAGC,GAED,MAAMA,cACJC,QAAQC,GAAG,CAACF,WAAW,IAAI;AAE7B,eAAeG;IACb,MAAMC,SAAS,IAAIC,oBAAW,CAACL;IAE/B,IAAI;QACF,MAAMI,OAAOE,OAAO;QACpBC,QAAQC,GAAG,CAAC;QAEZ,MAAMC,KAAKL,OAAOK,EAAE;QACpB,MAAMC,kBAAkBD,GAAGE,UAAU,CAAC;QAEtC,gCAAgC;QAChC,MAAMC,mBAAmB,MAAMF,gBAAgBG,cAAc,CAAC;YAC5DC,MAAM;gBAAEC,SAAS;YAAM;QACzB;QAEAR,QAAQC,GAAG,CAAC,CAAC,SAAS,EAAEI,iBAAiB,yBAAyB,CAAC;QAEnE,IAAIA,qBAAqB,GAAG;YAC1BL,QAAQC,GAAG,CAAC;YACZ;QACF;QAEA,kCAAkC;QAClC,MAAMQ,SAAS,MAAMN,gBAAgBO,UAAU,CAC7C;YAAEH,MAAM;gBAAEC,SAAS;YAAM;QAAE,GAC3B;YACEG,MAAM;gBACJJ,MAAM;gBACNK,eAAe,IAAIC;gBACnBC,sBAAsB;gBACtBC,eAAe;gBACfC,aAAa,EAAE;YACjB;QACF;QAGFhB,QAAQC,GAAG,CAAC,CAAC,UAAU,EAAEQ,OAAOQ,aAAa,CAAC,uBAAuB,CAAC;QAEtE,iBAAiB;QACjB,MAAMC,eAAe,MAAMf,gBACxBgB,IAAI,CAAC;YAAEZ,MAAM;QAAO,GACpBa,KAAK,CAAC,GACNC,OAAO;QAEVrB,QAAQC,GAAG,CAAC;QACZiB,aAAaI,OAAO,CAAC,CAACC;YACpBvB,QAAQC,GAAG,CAAC,CAAC,IAAI,EAAEsB,KAAKC,KAAK,CAAC,OAAO,EAAED,KAAKhB,IAAI,EAAE;QACpD;QAEAP,QAAQC,GAAG,CAAC;IACd,EAAE,OAAOwB,OAAO;QACdzB,QAAQyB,KAAK,CAAC,uBAAuBA;QACrC,MAAMA;IACR,SAAU;QACR,MAAM5B,OAAO6B,KAAK;QAClB1B,QAAQC,GAAG,CAAC;IACd;AACF;AAEA,gBAAgB;AAChBL,oBACG+B,IAAI,CAAC;IACJ3B,QAAQC,GAAG,CAAC;IACZP,QAAQkC,IAAI,CAAC;AACf,GACCC,KAAK,CAAC,CAACJ;IACNzB,QAAQyB,KAAK,CAAC,eAAeA;IAC7B/B,QAAQkC,IAAI,CAAC;AACf"}