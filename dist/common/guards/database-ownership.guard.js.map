{"version":3,"sources":["../../../src/common/guards/database-ownership.guard.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, Types } from 'mongoose';\r\nimport { Database } from '../../modules/dynamic-cms/schemas/database.schema';\r\n\r\n/**\r\n * Guard để kiểm tra user có quyền truy cập vào database hay không\r\n * Yêu cầu: JWT Guard phải chạy trước để có req.user\r\n * Header: x-database-id phải có giá trị\r\n */\r\n@Injectable()\r\nexport class DatabaseOwnershipGuard implements CanActivate {\r\n  constructor(\r\n    @InjectModel(Database.name)\r\n    private databaseModel: Model<Database>,\r\n  ) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    const request = context.switchToHttp().getRequest();\r\n    const user = request.user;\r\n    const databaseId = request.headers['x-database-id'];\r\n\r\n    // Kiểm tra có user từ JWT guard không\r\n    if (!user || !user.userId) {\r\n      throw new ForbiddenException('User authentication required');\r\n    }\r\n\r\n    // Kiểm tra có databaseId trong header không\r\n    if (!databaseId) {\r\n      throw new BadRequestException(\r\n        'Database ID is required in header x-database-id',\r\n      );\r\n    }\r\n\r\n    // Validate ObjectId format\r\n    if (!Types.ObjectId.isValid(databaseId)) {\r\n      throw new BadRequestException('Invalid Database ID format');\r\n    }\r\n\r\n    // Kiểm tra database có tồn tại và thuộc về user không\r\n    const database = await this.databaseModel\r\n      .findOne({\r\n        _id: new Types.ObjectId(databaseId),\r\n        userId: new Types.ObjectId(user.userId),\r\n        isActive: true,\r\n      })\r\n      .exec();\r\n\r\n    if (!database) {\r\n      throw new ForbiddenException(\r\n        'Database not found or you do not have access to this database',\r\n      );\r\n    }\r\n\r\n    // Lưu database vào request để sử dụng sau này nếu cần\r\n    request.database = database;\r\n\r\n    return true;\r\n  }\r\n}\r\n"],"names":["DatabaseOwnershipGuard","canActivate","context","request","switchToHttp","getRequest","user","databaseId","headers","userId","ForbiddenException","BadRequestException","Types","ObjectId","isValid","database","databaseModel","findOne","_id","isActive","exec","name"],"mappings":";;;;+BAiBaA;;;eAAAA;;;wBAXN;0BACqB;2BACC;gCACJ;;;;;;;;;;;;;;;AAQlB,IAAA,AAAMA,yBAAN,MAAMA;IAMX,MAAMC,YAAYC,OAAyB,EAAoB;QAC7D,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QACjD,MAAMC,OAAOH,QAAQG,IAAI;QACzB,MAAMC,aAAaJ,QAAQK,OAAO,CAAC,gBAAgB;QAEnD,sCAAsC;QACtC,IAAI,CAACF,QAAQ,CAACA,KAAKG,MAAM,EAAE;YACzB,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QAEA,4CAA4C;QAC5C,IAAI,CAACH,YAAY;YACf,MAAM,IAAII,2BAAmB,CAC3B;QAEJ;QAEA,2BAA2B;QAC3B,IAAI,CAACC,gBAAK,CAACC,QAAQ,CAACC,OAAO,CAACP,aAAa;YACvC,MAAM,IAAII,2BAAmB,CAAC;QAChC;QAEA,sDAAsD;QACtD,MAAMI,WAAW,MAAM,IAAI,CAACC,aAAa,CACtCC,OAAO,CAAC;YACPC,KAAK,IAAIN,gBAAK,CAACC,QAAQ,CAACN;YACxBE,QAAQ,IAAIG,gBAAK,CAACC,QAAQ,CAACP,KAAKG,MAAM;YACtCU,UAAU;QACZ,GACCC,IAAI;QAEP,IAAI,CAACL,UAAU;YACb,MAAM,IAAIL,0BAAkB,CAC1B;QAEJ;QAEA,sDAAsD;QACtDP,QAAQY,QAAQ,GAAGA;QAEnB,OAAO;IACT;IA9CA,YACE,AACQC,aAA8B,CACtC;aADQA,gBAAAA;IACP;AA4CL;;;qEA9C0BK"}