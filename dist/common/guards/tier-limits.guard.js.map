{"version":3,"sources":["../../../src/common/guards/tier-limits.guard.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, Types } from 'mongoose';\r\nimport { User, UserDocument } from '../../modules/users/schemas/user.schema';\r\nimport { getTierLimits, isUnlimited, AccountTier } from '../enums/tier.enum';\r\nimport {\r\n  Database,\r\n  DatabaseDocument,\r\n} from '../../modules/dynamic-cms/schemas/database.schema';\r\nimport {\r\n  DynamicData,\r\n  DynamicDataDocument,\r\n} from '../../modules/dynamic-cms/schemas/dynamic-data.schema';\r\nimport { ROUTE_PATTERNS } from '../constants/api-routes.constants';\r\n\r\n/**\r\n * Guard để kiểm tra giới hạn theo tier của user\r\n * Áp dụng cho:\r\n * - Giới hạn tạo database\r\n * - Giới hạn tạo data trong collection (single, bulk, replace-all)\r\n */\r\n@Injectable()\r\nexport class TierLimitsGuard implements CanActivate {\r\n  constructor(\r\n    @InjectModel(User.name) private userModel: Model<UserDocument>,\r\n    @InjectModel(Database.name) private databaseModel: Model<DatabaseDocument>,\r\n    @InjectModel(DynamicData.name)\r\n    private dynamicDataModel: Model<DynamicDataDocument>,\r\n  ) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    const request = context.switchToHttp().getRequest();\r\n    const userId = request.user?.userId;\r\n\r\n    if (!userId) {\r\n      throw new BadRequestException('User ID not found in request');\r\n    }\r\n\r\n    // Lấy thông tin user và tier\r\n    const user = await this.userModel.findById(userId).exec();\r\n    if (!user) {\r\n      throw new ForbiddenException('User not found');\r\n    }\r\n\r\n    const tierLimits = getTierLimits(user.tier);\r\n    const method = request.method;\r\n    const path = request.route?.path;\r\n\r\n    // Kiểm tra giới hạn dựa trên endpoint\r\n    if (this.isDatabaseCreation(method, path)) {\r\n      await this.checkDatabaseLimit(user, tierLimits);\r\n    } else if (this.isDataCreation(method, path, request)) {\r\n      await this.checkDataLimit(user, tierLimits, request);\r\n    } else if (this.isBulkCreation(method, path)) {\r\n      await this.checkBulkDataLimit(user, tierLimits, request);\r\n    } else if (this.isReplaceAll(method, path)) {\r\n      await this.checkReplaceAllLimit(user, tierLimits, request);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra xem có phải là tạo database không\r\n   */\r\n  private isDatabaseCreation(method: string, path: string): boolean {\r\n    return method === 'POST' && path === ROUTE_PATTERNS.DATABASE_CREATE;\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra xem có phải là tạo data không\r\n   */\r\n  private isDataCreation(method: string, path: string, request: any): boolean {\r\n    // POST /v1/:databaseId/:collectionName (không phải bulk hoặc replace-all)\r\n    return (\r\n      method === 'POST' &&\r\n      (path === ROUTE_PATTERNS.DATA_CREATE_V1 ||\r\n        path === ROUTE_PATTERNS.DATA_CREATE) &&\r\n      !path.includes('bulk') &&\r\n      !path.includes('replace-all')\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra xem có phải là bulk create không\r\n   */\r\n  private isBulkCreation(method: string, path: string): boolean {\r\n    return (\r\n      method === 'POST' &&\r\n      (path === ROUTE_PATTERNS.DATA_BULK_CREATE_V1 ||\r\n        path === ROUTE_PATTERNS.DATA_BULK_CREATE)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra xem có phải là replace-all không\r\n   */\r\n  private isReplaceAll(method: string, path: string): boolean {\r\n    return (\r\n      method === 'PUT' &&\r\n      (path === ROUTE_PATTERNS.DATA_REPLACE_ALL_V1 ||\r\n        path === ROUTE_PATTERNS.DATA_REPLACE_ALL)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra giới hạn tạo database\r\n   */\r\n  private async checkDatabaseLimit(\r\n    user: UserDocument,\r\n    tierLimits: any,\r\n  ): Promise<void> {\r\n    // Nếu unlimited thì bỏ qua\r\n    if (isUnlimited(tierLimits.maxDatabases)) {\r\n      return;\r\n    }\r\n\r\n    // Đếm số database hiện tại của user\r\n    const currentCount = await this.databaseModel\r\n      .countDocuments({\r\n        userId: user._id,\r\n        isActive: true,\r\n      })\r\n      .exec();\r\n\r\n    if (currentCount >= tierLimits.maxDatabases) {\r\n      throw new ForbiddenException(\r\n        `You have reached the maximum number of databases (${tierLimits.maxDatabases}) for your ${user.tier} tier. Please upgrade your account or delete unused databases.`,\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra giới hạn tạo data trong collection\r\n   */\r\n  private async checkDataLimit(\r\n    user: UserDocument,\r\n    tierLimits: any,\r\n    request: any,\r\n  ): Promise<void> {\r\n    // Nếu unlimited thì bỏ qua\r\n    if (isUnlimited(tierLimits.maxDataPerCollection)) {\r\n      return;\r\n    }\r\n\r\n    const databaseId = request.params.databaseId;\r\n    const collectionName = request.params.collectionName;\r\n\r\n    // Validate ObjectId format\r\n    if (!Types.ObjectId.isValid(databaseId)) {\r\n      throw new BadRequestException(\r\n        `Invalid databaseId format: \"${databaseId}\". Must be a 24 character hex string.`,\r\n      );\r\n    }\r\n\r\n    // Kiểm tra database có thuộc về user không\r\n    const database = await this.databaseModel\r\n      .findOne({\r\n        _id: databaseId,\r\n        userId: user._id,\r\n      })\r\n      .exec();\r\n\r\n    if (!database) {\r\n      throw new ForbiddenException(\r\n        'Database not found or you do not have access',\r\n      );\r\n    }\r\n\r\n    // Đếm số data hiện tại trong collection\r\n    const currentCount = await this.dynamicDataModel\r\n      .countDocuments({\r\n        databaseId: databaseId,\r\n        _collection: collectionName,\r\n      })\r\n      .exec();\r\n\r\n    if (currentCount >= tierLimits.maxDataPerCollection) {\r\n      throw new ForbiddenException(\r\n        `You have reached the maximum number of data (${tierLimits.maxDataPerCollection}) per collection for your ${user.tier} tier. Please upgrade your account or delete unused data.`,\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra giới hạn tạo bulk data\r\n   */\r\n  private async checkBulkDataLimit(\r\n    user: UserDocument,\r\n    tierLimits: any,\r\n    request: any,\r\n  ): Promise<void> {\r\n    // Nếu unlimited thì bỏ qua\r\n    if (isUnlimited(tierLimits.maxDataPerCollection)) {\r\n      return;\r\n    }\r\n\r\n    const databaseId = request.params.databaseId;\r\n    const collectionName = request.params.collectionName;\r\n    const dataArray = request.body;\r\n\r\n    if (!Array.isArray(dataArray)) {\r\n      throw new BadRequestException('Body must be an array');\r\n    }\r\n\r\n    // Validate ObjectId format\r\n    if (!Types.ObjectId.isValid(databaseId)) {\r\n      throw new BadRequestException(\r\n        `Invalid databaseId format: \"${databaseId}\". Must be a 24 character hex string.`,\r\n      );\r\n    }\r\n\r\n    // Kiểm tra database có thuộc về user không\r\n    const database = await this.databaseModel\r\n      .findOne({\r\n        _id: databaseId,\r\n        userId: user._id,\r\n      })\r\n      .exec();\r\n\r\n    if (!database) {\r\n      throw new ForbiddenException(\r\n        'Database not found or you do not have access',\r\n      );\r\n    }\r\n\r\n    // Đếm số data hiện tại trong collection\r\n    const currentCount = await this.dynamicDataModel\r\n      .countDocuments({\r\n        databaseId: databaseId,\r\n        _collection: collectionName,\r\n      })\r\n      .exec();\r\n\r\n    // Kiểm tra nếu thêm bulk data có vượt giới hạn không\r\n    const newTotal = currentCount + dataArray.length;\r\n\r\n    if (newTotal > tierLimits.maxDataPerCollection) {\r\n      throw new ForbiddenException(\r\n        `Cannot create ${dataArray.length} items. Current: ${currentCount}, Limit: ${tierLimits.maxDataPerCollection} for your ${user.tier} tier. You can add maximum ${tierLimits.maxDataPerCollection - currentCount} more items.`,\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra giới hạn replace-all\r\n   */\r\n  private async checkReplaceAllLimit(\r\n    user: UserDocument,\r\n    tierLimits: any,\r\n    request: any,\r\n  ): Promise<void> {\r\n    // Nếu unlimited thì bỏ qua\r\n    if (isUnlimited(tierLimits.maxDataPerCollection)) {\r\n      return;\r\n    }\r\n\r\n    const databaseId = request.params.databaseId;\r\n    const collectionName = request.params.collectionName;\r\n    const dataArray = request.body;\r\n\r\n    if (!Array.isArray(dataArray)) {\r\n      throw new BadRequestException('Body must be an array');\r\n    }\r\n\r\n    // Validate ObjectId format\r\n    if (!Types.ObjectId.isValid(databaseId)) {\r\n      throw new BadRequestException(\r\n        `Invalid databaseId format: \"${databaseId}\". Must be a 24 character hex string.`,\r\n      );\r\n    }\r\n\r\n    // Kiểm tra database có thuộc về user không\r\n    const database = await this.databaseModel\r\n      .findOne({\r\n        _id: databaseId,\r\n        userId: user._id,\r\n      })\r\n      .exec();\r\n\r\n    if (!database) {\r\n      throw new ForbiddenException(\r\n        'Database not found or you do not have access',\r\n      );\r\n    }\r\n\r\n    // Kiểm tra số lượng data mới có vượt giới hạn không\r\n    if (dataArray.length > tierLimits.maxDataPerCollection) {\r\n      throw new ForbiddenException(\r\n        `Cannot replace with ${dataArray.length} items. Maximum data per collection is ${tierLimits.maxDataPerCollection} for your ${user.tier} tier.`,\r\n      );\r\n    }\r\n  }\r\n}\r\n"],"names":["TierLimitsGuard","canActivate","context","request","switchToHttp","getRequest","userId","user","BadRequestException","userModel","findById","exec","ForbiddenException","tierLimits","getTierLimits","tier","method","path","route","isDatabaseCreation","checkDatabaseLimit","isDataCreation","checkDataLimit","isBulkCreation","checkBulkDataLimit","isReplaceAll","checkReplaceAllLimit","ROUTE_PATTERNS","DATABASE_CREATE","DATA_CREATE_V1","DATA_CREATE","includes","DATA_BULK_CREATE_V1","DATA_BULK_CREATE","DATA_REPLACE_ALL_V1","DATA_REPLACE_ALL","isUnlimited","maxDatabases","currentCount","databaseModel","countDocuments","_id","isActive","maxDataPerCollection","databaseId","params","collectionName","Types","ObjectId","isValid","database","findOne","dynamicDataModel","_collection","dataArray","body","Array","isArray","newTotal","length","name"],"mappings":"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"}