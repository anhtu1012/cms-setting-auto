{"version":3,"sources":["../../../src/common/tier/tier.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  BadRequestException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, Types } from 'mongoose';\r\nimport { User, UserDocument } from '../../modules/users/schemas/user.schema';\r\nimport {\r\n  Database,\r\n  DatabaseDocument,\r\n} from '../../modules/dynamic-cms/schemas/database.schema';\r\nimport {\r\n  DynamicData,\r\n  DynamicDataDocument,\r\n} from '../../modules/dynamic-cms/schemas/dynamic-data.schema';\r\nimport { TierConfigService } from './tier-config.service';\r\n\r\n/**\r\n * Service để kiểm tra và quản lý giới hạn theo tier\r\n * Sử dụng TierConfigService để lấy thông tin tier động từ database\r\n */\r\n@Injectable()\r\nexport class TierService {\r\n  constructor(\r\n    @InjectModel(User.name) private userModel: Model<UserDocument>,\r\n    @InjectModel(Database.name) private databaseModel: Model<DatabaseDocument>,\r\n    @InjectModel(DynamicData.name)\r\n    private dynamicDataModel: Model<DynamicDataDocument>,\r\n    private tierConfigService: TierConfigService,\r\n  ) {}\r\n\r\n  /**\r\n   * Lấy thông tin tier và usage của user\r\n   */\r\n  async getUserTierInfo(userId: string): Promise<{\r\n    tier: string;\r\n    limits: any;\r\n    usage: {\r\n      databases: number;\r\n      apiCallsToday: number;\r\n    };\r\n  }> {\r\n    const user = await this.userModel.findById(userId).exec();\r\n    if (!user) {\r\n      throw new Error('User not found');\r\n    }\r\n\r\n    const tierLimits = await this.tierConfigService.getTierLimits(user.tier);\r\n    const databaseCount = await this.databaseModel\r\n      .countDocuments({\r\n        userId: user._id,\r\n        isActive: true,\r\n      })\r\n      .exec();\r\n\r\n    return {\r\n      tier: user.tier,\r\n      limits: tierLimits,\r\n      usage: {\r\n        databases: databaseCount,\r\n        apiCallsToday: user.apiCallsToday || 0,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra xem user có thể tạo database mới không\r\n   */\r\n  async canCreateDatabase(userId: string): Promise<{\r\n    allowed: boolean;\r\n    reason?: string;\r\n    current: number;\r\n    limit: number;\r\n  }> {\r\n    const user = await this.userModel.findById(userId).exec();\r\n    if (!user) {\r\n      return {\r\n        allowed: false,\r\n        reason: 'User not found',\r\n        current: 0,\r\n        limit: 0,\r\n      };\r\n    }\r\n\r\n    const tierLimits = await this.tierConfigService.getTierLimits(user.tier);\r\n\r\n    // Nếu unlimited\r\n    if (this.tierConfigService.isUnlimited(tierLimits.maxDatabases)) {\r\n      return {\r\n        allowed: true,\r\n        current: -1,\r\n        limit: -1,\r\n      };\r\n    }\r\n\r\n    const currentCount = await this.databaseModel\r\n      .countDocuments({\r\n        userId: user._id,\r\n        isActive: true,\r\n      })\r\n      .exec();\r\n\r\n    const allowed = currentCount < tierLimits.maxDatabases;\r\n\r\n    return {\r\n      allowed,\r\n      reason: allowed\r\n        ? undefined\r\n        : `Maximum databases reached (${tierLimits.maxDatabases}) for ${user.tier} tier`,\r\n      current: currentCount,\r\n      limit: tierLimits.maxDatabases,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra xem user có thể tạo data mới trong collection không\r\n   */\r\n  async canCreateData(\r\n    userId: string,\r\n    databaseId: string,\r\n    collectionName: string,\r\n  ): Promise<{\r\n    allowed: boolean;\r\n    reason?: string;\r\n    current: number;\r\n    limit: number;\r\n  }> {\r\n    // Validate ObjectId format\r\n    if (!Types.ObjectId.isValid(databaseId)) {\r\n      throw new BadRequestException(\r\n        `Invalid databaseId format: \"${databaseId}\". Must be a 24 character hex string.`,\r\n      );\r\n    }\r\n\r\n    const user = await this.userModel.findById(userId).exec();\r\n    if (!user) {\r\n      return {\r\n        allowed: false,\r\n        reason: 'User not found',\r\n        current: 0,\r\n        limit: 0,\r\n      };\r\n    }\r\n\r\n    const tierLimits = await this.tierConfigService.getTierLimits(user.tier);\r\n\r\n    // Nếu unlimited\r\n    if (this.tierConfigService.isUnlimited(tierLimits.maxDataPerCollection)) {\r\n      return {\r\n        allowed: true,\r\n        current: -1,\r\n        limit: -1,\r\n      };\r\n    }\r\n\r\n    // Kiểm tra database có thuộc về user không\r\n    const database = await this.databaseModel\r\n      .findOne({\r\n        _id: databaseId,\r\n        userId: user._id,\r\n      })\r\n      .exec();\r\n\r\n    if (!database) {\r\n      return {\r\n        allowed: false,\r\n        reason: 'Database not found or access denied',\r\n        current: 0,\r\n        limit: tierLimits.maxDataPerCollection,\r\n      };\r\n    }\r\n\r\n    // Đếm số data hiện tại\r\n    const currentCount = await this.dynamicDataModel\r\n      .countDocuments({\r\n        databaseId: databaseId,\r\n        _collection: collectionName,\r\n      })\r\n      .exec();\r\n\r\n    const allowed = currentCount < tierLimits.maxDataPerCollection;\r\n\r\n    return {\r\n      allowed,\r\n      reason: allowed\r\n        ? undefined\r\n        : `Maximum data per collection reached (${tierLimits.maxDataPerCollection}) for ${user.tier} tier`,\r\n      current: currentCount,\r\n      limit: tierLimits.maxDataPerCollection,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Nâng cấp tier cho user\r\n   */\r\n  async upgradeTier(\r\n    userId: string,\r\n    newTier: string,\r\n    reason?: string,\r\n  ): Promise<UserDocument> {\r\n    const user = await this.userModel.findById(userId).exec();\r\n    if (!user) {\r\n      throw new Error('User not found');\r\n    }\r\n\r\n    // Kiểm tra tier mới có tồn tại không\r\n    await this.tierConfigService.getTierByCode(newTier);\r\n\r\n    // Lưu lịch sử\r\n    if (user.tier !== newTier) {\r\n      user.tierHistory.push({\r\n        tier: user.tier,\r\n        startDate:\r\n          user.tierStartDate ||\r\n          // createdAt may not be present on the typed document, fall back to cast or ObjectId timestamp\r\n          ((user as any).createdAt ??\r\n            (user._id as Types.ObjectId).getTimestamp()),\r\n        endDate: new Date(),\r\n        upgradeReason: reason,\r\n      });\r\n    }\r\n\r\n    user.tier = newTier;\r\n    user.tierStartDate = new Date();\r\n\r\n    // Set expiry date (1 năm cho các tier trả phí)\r\n    if (newTier !== 'free') {\r\n      const expiryDate = new Date();\r\n      expiryDate.setFullYear(expiryDate.getFullYear() + 1);\r\n      user.tierExpiryDate = expiryDate;\r\n    }\r\n\r\n    return await user.save();\r\n  }\r\n\r\n  /**\r\n   * Lấy thống kê sử dụng data của TẤT CẢ databases của user\r\n   */\r\n  async getAllDataUsage(userId: string): Promise<\r\n    Array<{\r\n      databaseId: string;\r\n      databaseName: string;\r\n      totalCollections: number;\r\n      totalData: number;\r\n      collections: Array<{\r\n        collection: string;\r\n        count: number;\r\n      }>;\r\n    }>\r\n  > {\r\n    const user = await this.userModel.findById(userId).exec();\r\n    if (!user) {\r\n      throw new Error('User not found');\r\n    }\r\n\r\n    // Lấy tất cả databases của user\r\n    const databases = await this.databaseModel\r\n      .find({ userId: new Types.ObjectId(userId) })\r\n      .exec();\r\n\r\n    const result = [];\r\n\r\n    for (const db of databases) {\r\n      // Đếm data theo collection cho từng database\r\n      const collections = await this.dynamicDataModel\r\n        .aggregate([\r\n          {\r\n            $match: {\r\n              databaseId: db._id.toString(),\r\n            },\r\n          },\r\n          {\r\n            $group: {\r\n              _id: '$_collection',\r\n              count: { $sum: 1 },\r\n            },\r\n          },\r\n          {\r\n            $sort: { count: -1 },\r\n          },\r\n        ])\r\n        .exec();\r\n\r\n      const totalData = collections.reduce((sum, col) => sum + col.count, 0);\r\n\r\n      result.push({\r\n        databaseId: db._id.toString(),\r\n        databaseName: db.name,\r\n        totalCollections: collections.length,\r\n        totalData: totalData,\r\n        collections: collections.map((col) => ({\r\n          collection: col._id,\r\n          count: col.count,\r\n        })),\r\n      });\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Lấy thống kê sử dụng data của user theo collection\r\n   */\r\n  async getDataUsageByCollection(\r\n    userId: string,\r\n    databaseId: string,\r\n  ): Promise<\r\n    Array<{\r\n      collection: string;\r\n      count: number;\r\n      limit: number;\r\n      percentage: number;\r\n    }>\r\n  > {\r\n    // Validate ObjectId format\r\n    if (!Types.ObjectId.isValid(databaseId)) {\r\n      throw new BadRequestException(\r\n        `Invalid databaseId format: \"${databaseId}\". Must be a 24 character hex string.`,\r\n      );\r\n    }\r\n\r\n    const user = await this.userModel.findById(userId).exec();\r\n    if (!user) {\r\n      throw new Error('User not found');\r\n    }\r\n\r\n    // Kiểm tra database có thuộc về user không\r\n    const database = await this.databaseModel\r\n      .findOne({\r\n        _id: new Types.ObjectId(databaseId),\r\n        userId: new Types.ObjectId(userId),\r\n      })\r\n      .exec();\r\n\r\n    if (!database) {\r\n      throw new ForbiddenException(\r\n        `Database not found or you don't have permission to access it`,\r\n      );\r\n    }\r\n\r\n    const tierLimits = await this.tierConfigService.getTierLimits(user.tier);\r\n\r\n    // Lấy danh sách collections và đếm data\r\n    const collections = await this.dynamicDataModel\r\n      .aggregate([\r\n        {\r\n          $match: {\r\n            databaseId: databaseId,\r\n          },\r\n        },\r\n        {\r\n          $group: {\r\n            _id: '$_collection',\r\n            count: { $sum: 1 },\r\n          },\r\n        },\r\n        {\r\n          $sort: { count: -1 },\r\n        },\r\n      ])\r\n      .exec();\r\n\r\n    return collections.map((col) => {\r\n      const limit = tierLimits.maxDataPerCollection;\r\n      const percentage = this.tierConfigService.isUnlimited(limit)\r\n        ? 0\r\n        : (col.count / limit) * 100;\r\n\r\n      return {\r\n        collection: col._id,\r\n        count: col.count,\r\n        limit: limit,\r\n        percentage: Math.round(percentage * 100) / 100,\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Reset API call counter (chạy hàng ngày)\r\n   */\r\n  async resetDailyApiCalls(): Promise<void> {\r\n    const today = new Date();\r\n    today.setHours(0, 0, 0, 0);\r\n\r\n    await this.userModel\r\n      .updateMany(\r\n        {\r\n          $or: [\r\n            { lastApiCallReset: { $lt: today } },\r\n            { lastApiCallReset: null },\r\n          ],\r\n        },\r\n        {\r\n          $set: {\r\n            apiCallsToday: 0,\r\n            lastApiCallReset: new Date(),\r\n          },\r\n        },\r\n      )\r\n      .exec();\r\n  }\r\n\r\n  /**\r\n   * Tăng API call counter\r\n   */\r\n  async incrementApiCalls(userId: string): Promise<void> {\r\n    await this.userModel\r\n      .findByIdAndUpdate(userId, {\r\n        $inc: { apiCallsToday: 1 },\r\n      })\r\n      .exec();\r\n  }\r\n}\r\n"],"names":["TierService","getUserTierInfo","userId","user","userModel","findById","exec","Error","tierLimits","tierConfigService","getTierLimits","tier","databaseCount","databaseModel","countDocuments","_id","isActive","limits","usage","databases","apiCallsToday","canCreateDatabase","allowed","reason","current","limit","isUnlimited","maxDatabases","currentCount","undefined","canCreateData","databaseId","collectionName","Types","ObjectId","isValid","BadRequestException","maxDataPerCollection","database","findOne","dynamicDataModel","_collection","upgradeTier","newTier","getTierByCode","tierHistory","push","startDate","tierStartDate","createdAt","getTimestamp","endDate","Date","upgradeReason","expiryDate","setFullYear","getFullYear","tierExpiryDate","save","getAllDataUsage","find","result","db","collections","aggregate","$match","toString","$group","count","$sum","$sort","totalData","reduce","sum","col","databaseName","name","totalCollections","length","map","collection","getDataUsageByCollection","ForbiddenException","percentage","Math","round","resetDailyApiCalls","today","setHours","updateMany","$or","lastApiCallReset","$lt","$set","incrementApiCalls","findByIdAndUpdate","$inc"],"mappings":"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"}