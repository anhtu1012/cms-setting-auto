{"version":3,"sources":["../../../src/common/tier/tier-config.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  ConflictException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model } from 'mongoose';\r\nimport { TierConfig, TierConfigDocument } from './schemas/tier-config.schema';\r\nimport {\r\n  CreateTierConfigDto,\r\n  UpdateTierConfigDto,\r\n} from './dto/tier-config.dto';\r\n\r\n/**\r\n * Service quản lý cấu hình Tier động\r\n */\r\n@Injectable()\r\nexport class TierConfigService {\r\n  // Cache để tránh query database nhiều lần\r\n  private tierCache = new Map<string, TierConfig>();\r\n  private cacheExpiry = new Map<string, number>();\r\n  private readonly CACHE_TTL = 5 * 60 * 1000; // 5 phút\r\n\r\n  constructor(\r\n    @InjectModel(TierConfig.name)\r\n    private tierConfigModel: Model<TierConfigDocument>,\r\n  ) {\r\n    // Khởi tạo cache khi service start\r\n    this.refreshCache();\r\n  }\r\n\r\n  /**\r\n   * Lấy tất cả tier configs\r\n   */\r\n  async getAllTiers(includeInactive = false): Promise<TierConfig[]> {\r\n    const query = includeInactive ? {} : { isActive: true };\r\n    return this.tierConfigModel.find(query).sort({ displayOrder: 1 }).exec();\r\n  }\r\n\r\n  /**\r\n   * Lấy tier config theo code\r\n   */\r\n  async getTierByCode(tierCode: string): Promise<TierConfig> {\r\n    // Kiểm tra cache trước\r\n    const cached = this.getCachedTier(tierCode);\r\n    if (cached) {\r\n      return cached;\r\n    }\r\n\r\n    const tier = await this.tierConfigModel\r\n      .findOne({ tierCode, isActive: true })\r\n      .exec();\r\n\r\n    if (!tier) {\r\n      throw new NotFoundException(`Tier '${tierCode}' not found`);\r\n    }\r\n\r\n    // Lưu vào cache\r\n    this.setCachedTier(tierCode, tier);\r\n    return tier;\r\n  }\r\n\r\n  /**\r\n   * Lấy tier limits (chỉ các thông tin giới hạn)\r\n   */\r\n  async getTierLimits(tierCode: string) {\r\n    const tier = await this.getTierByCode(tierCode);\r\n    return {\r\n      maxDatabases: tier.maxDatabases,\r\n      maxDataPerCollection: tier.maxDataPerCollection,\r\n      maxCollectionsPerDatabase: tier.maxCollectionsPerDatabase,\r\n      maxStorageGB: tier.maxStorageGB,\r\n      maxApiCallsPerDay: tier.maxApiCallsPerDay,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Tạo tier mới\r\n   */\r\n  async createTier(createDto: CreateTierConfigDto): Promise<TierConfig> {\r\n    // Kiểm tra tierCode đã tồn tại chưa\r\n    const existing = await this.tierConfigModel\r\n      .findOne({ tierCode: createDto.tierCode })\r\n      .exec();\r\n\r\n    if (existing) {\r\n      throw new ConflictException(\r\n        `Tier '${createDto.tierCode}' already exists`,\r\n      );\r\n    }\r\n\r\n    const tier = new this.tierConfigModel(createDto);\r\n    const saved = await tier.save();\r\n\r\n    // Clear cache để refresh\r\n    this.clearCache();\r\n\r\n    return saved;\r\n  }\r\n\r\n  /**\r\n   * Cập nhật tier\r\n   */\r\n  async updateTier(\r\n    tierCode: string,\r\n    updateDto: UpdateTierConfigDto,\r\n  ): Promise<TierConfig> {\r\n    const tier = await this.tierConfigModel\r\n      .findOneAndUpdate({ tierCode }, updateDto, { new: true })\r\n      .exec();\r\n\r\n    if (!tier) {\r\n      throw new NotFoundException(`Tier '${tierCode}' not found`);\r\n    }\r\n\r\n    // Clear cache\r\n    this.clearCache();\r\n\r\n    return tier;\r\n  }\r\n\r\n  /**\r\n   * Xóa tier (soft delete bằng cách set isActive = false)\r\n   */\r\n  async deleteTier(tierCode: string): Promise<void> {\r\n    const result = await this.tierConfigModel\r\n      .updateOne({ tierCode }, { isActive: false })\r\n      .exec();\r\n\r\n    if (result.modifiedCount === 0) {\r\n      throw new NotFoundException(`Tier '${tierCode}' not found`);\r\n    }\r\n\r\n    // Clear cache\r\n    this.clearCache();\r\n  }\r\n\r\n  /**\r\n   * Hard delete tier (cẩn thận!)\r\n   */\r\n  async hardDeleteTier(tierCode: string): Promise<void> {\r\n    const result = await this.tierConfigModel.deleteOne({ tierCode }).exec();\r\n\r\n    if (result.deletedCount === 0) {\r\n      throw new NotFoundException(`Tier '${tierCode}' not found`);\r\n    }\r\n\r\n    // Clear cache\r\n    this.clearCache();\r\n  }\r\n\r\n  /**\r\n   * Kiểm tra giá trị có phải unlimited không\r\n   */\r\n  isUnlimited(limit: number): boolean {\r\n    return limit === -1;\r\n  }\r\n\r\n  /**\r\n   * Seed default tiers vào database\r\n   */\r\n  async seedDefaultTiers(): Promise<void> {\r\n    const defaultTiers: CreateTierConfigDto[] = [\r\n      {\r\n        tierCode: 'free',\r\n        tierName: 'Free',\r\n        description: 'Gói miễn phí cho người dùng mới',\r\n        maxDatabases: 2,\r\n        maxDataPerCollection: 100,\r\n        maxCollectionsPerDatabase: 5,\r\n        maxStorageGB: 1,\r\n        maxApiCallsPerDay: 1000,\r\n        price: 0,\r\n        currency: 'USD',\r\n        isActive: true,\r\n        displayOrder: 0,\r\n      },\r\n      {\r\n        tierCode: 'basic',\r\n        tierName: 'Basic',\r\n        description: 'Gói cơ bản cho dự án nhỏ',\r\n        maxDatabases: 5,\r\n        maxDataPerCollection: 1000,\r\n        maxCollectionsPerDatabase: 20,\r\n        maxStorageGB: 5,\r\n        maxApiCallsPerDay: 10000,\r\n        price: 9.99,\r\n        currency: 'USD',\r\n        isActive: true,\r\n        displayOrder: 1,\r\n      },\r\n      {\r\n        tierCode: 'premium',\r\n        tierName: 'Premium',\r\n        description: 'Gói cao cấp cho doanh nghiệp vừa',\r\n        maxDatabases: 20,\r\n        maxDataPerCollection: 10000,\r\n        maxCollectionsPerDatabase: 100,\r\n        maxStorageGB: 50,\r\n        maxApiCallsPerDay: 100000,\r\n        price: 49.99,\r\n        currency: 'USD',\r\n        isActive: true,\r\n        displayOrder: 2,\r\n      },\r\n      {\r\n        tierCode: 'enterprise',\r\n        tierName: 'Enterprise',\r\n        description: 'Gói không giới hạn cho doanh nghiệp lớn',\r\n        maxDatabases: -1,\r\n        maxDataPerCollection: -1,\r\n        maxCollectionsPerDatabase: -1,\r\n        maxStorageGB: -1,\r\n        maxApiCallsPerDay: -1,\r\n        price: 199.99,\r\n        currency: 'USD',\r\n        isActive: true,\r\n        displayOrder: 3,\r\n      },\r\n    ];\r\n\r\n    for (const tierDto of defaultTiers) {\r\n      const existing = await this.tierConfigModel\r\n        .findOne({ tierCode: tierDto.tierCode })\r\n        .exec();\r\n\r\n      if (!existing) {\r\n        await this.tierConfigModel.create(tierDto);\r\n      }\r\n    }\r\n\r\n    // Refresh cache\r\n    this.clearCache();\r\n  }\r\n\r\n  /**\r\n   * Cache management\r\n   */\r\n  private getCachedTier(tierCode: string): TierConfig | null {\r\n    const expiry = this.cacheExpiry.get(tierCode);\r\n    if (expiry && Date.now() < expiry) {\r\n      return this.tierCache.get(tierCode) || null;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private setCachedTier(tierCode: string, tier: TierConfig): void {\r\n    this.tierCache.set(tierCode, tier);\r\n    this.cacheExpiry.set(tierCode, Date.now() + this.CACHE_TTL);\r\n  }\r\n\r\n  private clearCache(): void {\r\n    this.tierCache.clear();\r\n    this.cacheExpiry.clear();\r\n    // Refresh cache sau khi clear\r\n    this.refreshCache();\r\n  }\r\n\r\n  private async refreshCache(): Promise<void> {\r\n    try {\r\n      const tiers = await this.tierConfigModel.find({ isActive: true }).exec();\r\n      for (const tier of tiers) {\r\n        this.setCachedTier(tier.tierCode, tier);\r\n      }\r\n    } catch (error) {\r\n      // Ignore errors during cache refresh\r\n      console.error('Failed to refresh tier cache:', error);\r\n    }\r\n  }\r\n}\r\n"],"names":["TierConfigService","getAllTiers","includeInactive","query","isActive","tierConfigModel","find","sort","displayOrder","exec","getTierByCode","tierCode","cached","getCachedTier","tier","findOne","NotFoundException","setCachedTier","getTierLimits","maxDatabases","maxDataPerCollection","maxCollectionsPerDatabase","maxStorageGB","maxApiCallsPerDay","createTier","createDto","existing","ConflictException","saved","save","clearCache","updateTier","updateDto","findOneAndUpdate","new","deleteTier","result","updateOne","modifiedCount","hardDeleteTier","deleteOne","deletedCount","isUnlimited","limit","seedDefaultTiers","defaultTiers","tierName","description","price","currency","tierDto","create","expiry","cacheExpiry","get","Date","now","tierCache","set","CACHE_TTL","clear","refreshCache","tiers","error","console","Map","name"],"mappings":"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"}