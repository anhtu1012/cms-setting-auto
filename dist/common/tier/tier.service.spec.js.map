{"version":3,"sources":["../../../src/common/tier/tier.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\r\nimport { getModelToken } from '@nestjs/mongoose';\r\nimport { TierService } from './tier.service';\r\nimport { TierConfigService } from './tier-config.service';\r\nimport { User } from '../../modules/users/schemas/user.schema';\r\nimport { Database } from '../../modules/dynamic-cms/schemas/database.schema';\r\nimport { DynamicData } from '../../modules/dynamic-cms/schemas/dynamic-data.schema';\r\nimport { TierConfig } from './schemas/tier-config.schema';\r\n\r\ndescribe('TierService', () => {\r\n  let service: TierService;\r\n  let tierConfigService: TierConfigService;\r\n  let userModel: any;\r\n  let databaseModel: any;\r\n  let dynamicDataModel: any;\r\n\r\n  const mockUser = {\r\n    _id: '507f1f77bcf86cd799439011',\r\n    email: 'test@example.com',\r\n    tier: 'free',\r\n    currentDatabaseCount: 0,\r\n    apiCallsToday: 0,\r\n    save: jest.fn().mockResolvedValue(this),\r\n  };\r\n\r\n  const mockTierConfigService = {\r\n    getTierLimits: jest.fn().mockResolvedValue({\r\n      maxDatabases: 2,\r\n      maxDataPerCollection: 100,\r\n      maxCollectionsPerDatabase: 5,\r\n      maxStorageGB: 1,\r\n      maxApiCallsPerDay: 1000,\r\n    }),\r\n    getTierByCode: jest.fn().mockResolvedValue({\r\n      tierCode: 'free',\r\n      tierName: 'Free',\r\n      maxDatabases: 2,\r\n      maxDataPerCollection: 100,\r\n      maxCollectionsPerDatabase: 5,\r\n      maxStorageGB: 1,\r\n      maxApiCallsPerDay: 1000,\r\n    }),\r\n    isUnlimited: jest.fn((limit: number) => limit === -1),\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        TierService,\r\n        {\r\n          provide: TierConfigService,\r\n          useValue: mockTierConfigService,\r\n        },\r\n        {\r\n          provide: getModelToken(User.name),\r\n          useValue: {\r\n            findById: jest.fn(),\r\n            updateMany: jest.fn(),\r\n            findByIdAndUpdate: jest.fn(),\r\n          },\r\n        },\r\n        {\r\n          provide: getModelToken(Database.name),\r\n          useValue: {\r\n            countDocuments: jest.fn(),\r\n            findOne: jest.fn(),\r\n          },\r\n        },\r\n        {\r\n          provide: getModelToken(DynamicData.name),\r\n          useValue: {\r\n            countDocuments: jest.fn(),\r\n            aggregate: jest.fn(),\r\n          },\r\n        },\r\n        {\r\n          provide: getModelToken(TierConfig.name),\r\n          useValue: {\r\n            find: jest.fn(),\r\n            findOne: jest.fn(),\r\n            create: jest.fn(),\r\n          },\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<TierService>(TierService);\r\n    tierConfigService = module.get<TierConfigService>(TierConfigService);\r\n    userModel = module.get(getModelToken(User.name));\r\n    databaseModel = module.get(getModelToken(Database.name));\r\n    dynamicDataModel = module.get(getModelToken(DynamicData.name));\r\n  });\r\n\r\n  it('should be defined', () => {\r\n    expect(service).toBeDefined();\r\n  });\r\n\r\n  describe('getUserTierInfo', () => {\r\n    it('should return tier info for user', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.countDocuments.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(1),\r\n      });\r\n\r\n      const result = await service.getUserTierInfo(mockUser._id);\r\n\r\n      expect(result).toHaveProperty('tier');\r\n      expect(result).toHaveProperty('limits');\r\n      expect(result).toHaveProperty('usage');\r\n      expect(result.tier).toBe('free');\r\n      expect(result.limits.maxDatabases).toBe(2);\r\n      expect(result.usage.databases).toBe(1);\r\n    });\r\n  });\r\n\r\n  describe('canCreateDatabase', () => {\r\n    it('should allow database creation when under limit', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.countDocuments.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(1), // User has 1 database\r\n      });\r\n\r\n      const result = await service.canCreateDatabase(mockUser._id);\r\n\r\n      expect(result.allowed).toBe(true);\r\n      expect(result.current).toBe(1);\r\n      expect(result.limit).toBe(2);\r\n    });\r\n\r\n    it('should block database creation when limit reached', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.countDocuments.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(2), // User has 2 databases (FREE limit)\r\n      });\r\n\r\n      const result = await service.canCreateDatabase(mockUser._id);\r\n\r\n      expect(result.allowed).toBe(false);\r\n      expect(result.current).toBe(2);\r\n      expect(result.limit).toBe(2);\r\n      expect(result.reason).toContain('Maximum databases reached');\r\n    });\r\n\r\n    it('should allow unlimited databases for ENTERPRISE tier', async () => {\r\n      const enterpriseUser = { ...mockUser, tier: 'enterprise' };\r\n\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(enterpriseUser),\r\n      });\r\n\r\n      // Mock unlimited tier limits\r\n      mockTierConfigService.getTierLimits.mockResolvedValueOnce({\r\n        maxDatabases: -1,\r\n        maxDataPerCollection: -1,\r\n        maxCollectionsPerDatabase: -1,\r\n        maxStorageGB: -1,\r\n        maxApiCallsPerDay: -1,\r\n      });\r\n\r\n      const result = await service.canCreateDatabase(mockUser._id);\r\n\r\n      expect(result.allowed).toBe(true);\r\n      expect(result.current).toBe(-1);\r\n      expect(result.limit).toBe(-1);\r\n    });\r\n  });\r\n\r\n  describe('canCreateData', () => {\r\n    const databaseId = '507f1f77bcf86cd799439022';\r\n    const collectionName = 'products';\r\n\r\n    it('should allow data creation when under limit', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.findOne.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue({ _id: databaseId }),\r\n      });\r\n\r\n      dynamicDataModel.countDocuments.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(50), // 50 data items\r\n      });\r\n\r\n      const result = await service.canCreateData(\r\n        mockUser._id,\r\n        databaseId,\r\n        collectionName,\r\n      );\r\n\r\n      expect(result.allowed).toBe(true);\r\n      expect(result.current).toBe(50);\r\n      expect(result.limit).toBe(100); // FREE tier limit\r\n    });\r\n\r\n    it('should block data creation when limit reached', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.findOne.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue({ _id: databaseId }),\r\n      });\r\n\r\n      dynamicDataModel.countDocuments.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(100), // Reached FREE limit\r\n      });\r\n\r\n      const result = await service.canCreateData(\r\n        mockUser._id,\r\n        databaseId,\r\n        collectionName,\r\n      );\r\n\r\n      expect(result.allowed).toBe(false);\r\n      expect(result.current).toBe(100);\r\n      expect(result.limit).toBe(100);\r\n      expect(result.reason).toContain('Maximum data per collection reached');\r\n    });\r\n\r\n    it('should return false if database not found', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.findOne.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(null),\r\n      });\r\n\r\n      const result = await service.canCreateData(\r\n        mockUser._id,\r\n        databaseId,\r\n        collectionName,\r\n      );\r\n\r\n      expect(result.allowed).toBe(false);\r\n      expect(result.reason).toContain('Database not found');\r\n    });\r\n  });\r\n\r\n  describe('upgradeTier', () => {\r\n    it('should upgrade user tier and save history', async () => {\r\n      const userWithSave = {\r\n        ...mockUser,\r\n        tierHistory: [],\r\n        createdAt: new Date(),\r\n        save: jest.fn().mockResolvedValue(mockUser),\r\n      };\r\n\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(userWithSave),\r\n      });\r\n\r\n      const result = await service.upgradeTier(\r\n        mockUser._id,\r\n        'premium',\r\n        'Payment successful',\r\n      );\r\n\r\n      expect(userWithSave.save).toHaveBeenCalled();\r\n      expect(userWithSave.tier).toBe('premium');\r\n      expect(userWithSave.tierHistory.length).toBe(1);\r\n      expect(userWithSave.tierHistory[0].upgradeReason).toBe(\r\n        'Payment successful',\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('getDataUsageByCollection', () => {\r\n    it('should return data usage statistics', async () => {\r\n      const databaseId = '507f1f77bcf86cd799439022';\r\n\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      dynamicDataModel.aggregate.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue([\r\n          { _id: 'products', count: 85 },\r\n          { _id: 'categories', count: 15 },\r\n        ]),\r\n      });\r\n\r\n      const result = await service.getDataUsageByCollection(\r\n        mockUser._id,\r\n        databaseId,\r\n      );\r\n\r\n      expect(result).toHaveLength(2);\r\n      expect(result[0].collection).toBe('products');\r\n      expect(result[0].count).toBe(85);\r\n      expect(result[0].limit).toBe(100);\r\n      expect(result[0].percentage).toBe(85);\r\n    });\r\n  });\r\n\r\n  describe('Bulk and Replace-All scenarios', () => {\r\n    const databaseId = '507f1f77bcf86cd799439022';\r\n    const collectionName = 'products';\r\n\r\n    it('should allow bulk creation when under limit', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.findOne.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue({ _id: databaseId }),\r\n      });\r\n\r\n      dynamicDataModel.countDocuments.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(50), // Current: 50, adding 30 = 80 (under 100)\r\n      });\r\n\r\n      const result = await service.canCreateData(\r\n        mockUser._id,\r\n        databaseId,\r\n        collectionName,\r\n      );\r\n\r\n      expect(result.allowed).toBe(true);\r\n    });\r\n\r\n    it('should block bulk creation when would exceed limit', async () => {\r\n      userModel.findById.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(mockUser),\r\n      });\r\n\r\n      databaseModel.findOne.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue({ _id: databaseId }),\r\n      });\r\n\r\n      dynamicDataModel.countDocuments.mockReturnValue({\r\n        exec: jest.fn().mockResolvedValue(90), // Current: 90, adding 20 would exceed 100\r\n      });\r\n\r\n      const result = await service.canCreateData(\r\n        mockUser._id,\r\n        databaseId,\r\n        collectionName,\r\n      );\r\n\r\n      expect(result.allowed).toBe(true); // Still allowed to add up to 10 more\r\n    });\r\n  });\r\n});\r\n"],"names":["describe","service","tierConfigService","userModel","databaseModel","dynamicDataModel","mockUser","_id","email","tier","currentDatabaseCount","apiCallsToday","save","jest","fn","mockResolvedValue","mockTierConfigService","getTierLimits","maxDatabases","maxDataPerCollection","maxCollectionsPerDatabase","maxStorageGB","maxApiCallsPerDay","getTierByCode","tierCode","tierName","isUnlimited","limit","beforeEach","module","Test","createTestingModule","providers","TierService","provide","TierConfigService","useValue","getModelToken","User","name","findById","updateMany","findByIdAndUpdate","Database","countDocuments","findOne","DynamicData","aggregate","TierConfig","find","create","compile","get","it","expect","toBeDefined","mockReturnValue","exec","result","getUserTierInfo","toHaveProperty","toBe","limits","usage","databases","canCreateDatabase","allowed","current","reason","toContain","enterpriseUser","mockResolvedValueOnce","databaseId","collectionName","canCreateData","userWithSave","tierHistory","createdAt","Date","upgradeTier","toHaveBeenCalled","length","upgradeReason","count","getDataUsageByCollection","toHaveLength","collection","percentage"],"mappings":"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"}